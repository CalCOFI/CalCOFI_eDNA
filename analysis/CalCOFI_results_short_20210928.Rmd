---
title: "CalCOFI_results_20210715"
author: "Zack Gold"
date: "7/15/2021"
output: html_document
---
# Prep Code
## Load Libraries
```{r, hide = TRUE}

library(tidyverse)
library(rstanarm)
options(mc.cores = parallel::detectCores())
library(bayesplot)
library(modelr)
library(tidybayes)
library(heatmaply)
library(wesanderson)
library(dendextend)
library(ggpmisc)
library(here)
library(vegan)
library(ggdendro)
library(rioja)
library(cluster)
library(ggrepel)
library(grid)
library(RColorBrewer)
library(ggallin)
library(patchwork)

```

## Color Palletes
```{r, Color Palletes ,results='hide'}
# Colors
wes_palette("Darjeeling2") -> dar2
wes_palette("Darjeeling1") -> dar1
wes_palette("FantasticFox1") -> moon1
wes_palette("Royal1") -> br2
wes_palette("Rushmore1") -> br1
wes_palette("IsleofDogs1") -> id1
wes_palette("Royal2") -> id2

dar3 <- c(dar2[2], dar1[2], dar2[4], dar2[3], moon1[5])
#show_col(dar3)

dar4 <- c(id1[1], dar1[2], dar2[2], dar2[3])
#show_col(dar4)
wes_palette("Zissou1") -> moon2
moon3 <- c(id1[1], moon2[1], br2[4], br1[4], br1[3], moon2[5])
#show_col(moon3)

col_27 <-
c(dar1,
dar2,
id1,
id2,
moon2[1],
moon1[5],
br1[3],
br2[1],
moon2[3],
"darkseagreen",
"dodgerblue")
col_27[10] <- br2[4]
col_27[13] <- br1[4]

col_23 <- c(dar1, dar2, id1, id2, moon2[1], moon1[5])

palette.new <- read_csv(here("data", "alternative.pallete.csv"))

palette.new3 <-
read_csv(here("data", "alternative.pallete.csv")) %>% filter (!str_detect(Type, "Coastal Pelagic North"))


pallete.fib1b <-
palette.new %>% filter (!str_detect(Type, "Benthic Cosmopolitan")) %>% filter (!str_detect(Type, "Coastal Pelagic North"))


```

## Temperature

```{r}


metadata2 <-
read.csv(file = "../data/calcofi_metadata_analysis_20210907.csv")

metadata2 %>%
mutate(
.,
station = fct_recode(
Sta_ID,
"80_60" =  "080.0 060.0" ,
"86.7_50" = "086.7 050.0" ,
"93.3_30" = "093.3 030.0",
"93.3_60" = "093.3 060.0"
)
) %>%
group_by(Year, station) %>%
dplyr::summarise(two_month_sst = mean(two_month_sst)) -> two_month_sst

metadata2 %>%
mutate(
.,
station = fct_recode(
Sta_ID,
"80_60" =  "080.0 060.0" ,
"86.7_50" = "086.7 050.0" ,
"93.3_30" = "093.3 030.0",
"93.3_60" = "093.3 060.0"
)
) %>%
group_by(Year) %>%
dplyr::summarise(mean_two_month_sst = mean(two_month_sst)) -> two_month_sst_mean

```
### Temp plot
```{r}



metadata2  %>%
mutate(
.,
station = fct_recode(
Sta_ID,
"Pt. Conception" =  "080.0 060.0" ,
"San Nicholas Island" = "086.7 050.0" ,
"San Diego Inshore" = "093.3 030.0",
"San Diego Offshore" = "093.3 060.0"
)
) %>%
ggplot(., aes(
x = Year,
y = two_month_sst,
group = station,
color = station
)) +
geom_line(size = 1) +
scale_color_manual(values = dar4) +
annotate(
"rect",
xmin = 2014,
xmax = 2019,
ymin = 11.5,
ymax = 19.5,
alpha = .2,
fill = "darkred"
) +
theme_bw() +
theme(
panel.background = element_rect(fill = 'white', colour = 'white'),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text.x = element_text(size = 12, angle = 30, hjust = 1),
axis.text.y = element_text(size = 12, angle = 0),
axis.title.x =element_text(size = 16,  face = "bold"),
axis.title.y = element_text(size = 16, angle = 90, face = "bold"),
strip.background = element_rect(fill = 'grey90'),
strip.text.x = element_text(size = 15, face = 'italic'),
legend.text = element_text(size = 12),
legend.position = c(0.5, 0.8),
legend.title = element_blank(),
legend.box = "vertical"
) + ylab(" SST ˚C")  -> temp_plot

temp_plot


ggsave(
temp_plot,
file = here::here("analysis", "figures", "temp_plot.png"),
width = 14,
height = 8
)  

```

```{r}



metadata2  %>%
mutate(
.,
station = fct_recode(
Sta_ID,
"Pt. Conception" =  "080.0 060.0" ,
"San Nicholas Island" = "086.7 050.0" ,
"San Diego Inshore" = "093.3 030.0",
"San Diego Offshore" = "093.3 060.0"
)
) %>%
filter(., station == "Pt. Conception") %>%
ggplot(., aes(
x = Year,
y = two_month_sst,
group = station,
color = station
)) +
geom_line(size = 1) +
scale_color_manual(values = dar4) +
annotate(
"rect",
xmin = 2014,
xmax = 2019,
ymin = 11.5,
ymax = 15.5,
alpha = .2,
fill = "darkred"
) +
theme_bw() +
theme(
panel.background = element_rect(fill = 'white', colour = 'white'),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text.x = element_blank(),
axis.ticks.x = element_blank(),
axis.text.y = element_text(size = 12, angle = 0),
axis.title.x = element_blank(),
axis.title.y = element_text(size = 16, angle = 90, face = "bold"),
strip.background = element_rect(fill = 'grey90'),
strip.text.x = element_text(size = 15, face = 'italic'),
legend.text = element_text(size = 12),
legend.position = c(0.5, 0.8),
legend.title = element_blank(),
legend.box = "vertical"
) + ylab(" SST ˚C")  -> temp_plot_conc

temp_plot_conc


```

## Trait Data
```{r}



#Trait Data
trait_edna_1 <-
read.csv("../data/habitat_association_to_check_art.csv", header = T)
as.data.frame(trait_edna_1) -> trait_edna

trait_edna %>%
arrange(ID_master) %>% mutate(name = str_replace(ID_master, " ", ".")) %>%  mutate(., ID_master = str_replace(ID_master, "AANOTHER", "sp."))   %>% dplyr::select(-Type) %>%
mutate(Type = str_c(Habitat, " ", Range)) -> trait_edna

trait_edna$Type %>%  unique()

trait_edna %>%
mutate(
.,
species_color = case_when(
Type == "Benthic North" ~ "#006d2c",
Type == "Benthic Central"  ~ "#31a354"  ,
Type == "Benthic Cosmopolitan"  ~
"#31a354"  ,
Type == "Benthic South"  ~ "#74c476"  ,
Type == "Mesopelagic North" ~ "#08519c",
Type == "Mesopelagic South"  ~ "#cb181d" ,
Type == "Mesopelagic Cosmopolitan"  ~ "#6baed6" ,
Type == "Mesopelagic Central" ~ "#3182bd" ,
Type == "Coastal Pelagic Central" ~ "#969696",
Type == "Coastal Pelagic North" ~ "#969696",
Type == "Cosmopolitan"   ~ "grey80"   ,
TRUE ~ "white"
)
) -> trait_edna


```



### STAN Data
```{r, function for transforming eDNA Index,results='hide'}
#load(here("data","Stan_Fit_combined_20210929_1338.RData"))

```

```{r, Format Stan Data for SST Comparisons, results='hide'}
##### SST Data
#
# stanMod <- Output$stanMod
# rm(Output)
# pars2 <- rstan::extract(stanMod, par = "b_master_grid")
# rm(stanMod)
# Stations <- Output$Stations
# Stations %>%
#      separate(station_id, into = c("Year","Rpt_Line","Rpt_Sta"), remove = F, sep="_") %>%
#      unite(., "station" , c("Rpt_Line","Rpt_Sta"), remove=FALSE) -> Stations
#
#  species_mapping <-  Output$species_mapping %>%  mutate(., ID_master = str_replace(ID_master, "AANOTHER","sp."))
#
# pars2$b_master_grid %>%
#   as_tibble() %>%
#   pivot_longer(., cols = `1.1`:`85.56`, names_to="station.species", values_to = "est") %>%
#   separate(station.species, into = c("station_idx","sp_index_master"), remove = F, sep="\\.") %>%
#   mutate(., station_idx = as.numeric(station_idx),
#          sp_index_master = as.numeric(sp_index_master)) %>%
#    left_join(species_mapping) %>%
#      left_join(Stations) -> b_grid_tibble
#
# saveRDS(b_grid_tibble, here("data","b_grid_tibble_rpkn.RDS"))

b_grid_tibble <- readRDS(file = here("data", "b_grid_tibble_rpkn.RDS"))
```

### Year - Species Mean
```{r}
b_grid_tibble %>%
  mutate(., log_est = log(est + 0.01)) %>%
  group_by(Year, ID_master) %>%
  dplyr::summarise(
  mean = mean(est),
  median = median(est),
  sd = sd(est),
  p05 = quantile(est, probs = 0.05),
  p95 = quantile(est, probs = 0.95)
  ) %>%
  mutate(mean_log = log(mean + 0.1), sd_log = log(sd + 0.1)) -> b_master_out
  

```

### Year - Type Mean
```{r}
b_grid_tibble %>%
  mutate(., log_est = log(est + 0.01)) %>%
  left_join(trait_edna, by = c("ID_master")) %>%
  group_by(Year, Type) %>%
  dplyr::summarise(
  mean = mean(est),
  sum = sum(est),
  mean_log = mean(log_est),
  sd_log = sd(log_est),
  p05_log = quantile(log_est, probs = 0.05),
  p95_log = quantile(log_est, probs = 0.95)
  ) -> b_master_out_type
  
  b_master_out_type %>%
  mutate(., log_sum = log(sum + 0.01)) -> b_master_out_type


```

### Year - Site - Species
```{r, results='hide'}


b_grid_tibble %>%
mutate(., log_est = log(est + 0.01)) %>%
group_by(Year, station, ID_master) %>%
dplyr::summarise(
mean = mean(est),
median = median(est),
sd = sd(est),
p05 = quantile(est, probs = 0.05),
p95 = quantile(est, probs = 0.95)
) %>%
mutate(mean_log = log(mean + 0.01), sd_log = log(sd + 0.01)) -> b_master_out_site
b_master_out_site$Year  <- as.numeric(b_master_out_site$Year)

# Format Data
test_nest_a <- b_master_out_site %>%
mutate(.,
Normalized.biomass = mean,
log_Normalized.biomass = mean_log) %>%
left_join(two_month_sst) %>%
mutate(PA_biomass = if_else(Normalized.biomass > 0.01, 1, 0)) %>%  #NOTE change to small value, rather than actual zero, given model output
ungroup() %>%
mutate(temp_std = (two_month_sst - mean(two_month_sst)) / sd(two_month_sst)) %>%
mutate(., ID_master = str_replace(ID_master, "AANOTHER", "sp.")) %>%
group_by(ID_master) %>%
nest

```

### MHW Comparison - Species
```{r, Format Stan Data for MHW Comparisons, results='hide'}


##### MHW Data
# 
# pars2$b_master_grid  %>%
# as_tibble() %>% mutate(id = row_number()) %>%
# pivot_longer(.,
# cols = `1.1`:`85.56`,
# names_to = "station.species",
# values_to = "est") %>%
# separate(
# station.species,
# into = c("station_idx", "sp_index_master"),
# remove = F,
# sep = "\\."
# ) %>%
# mutate(
# .,
# station_idx = as.numeric(station_idx),
# sp_index_master = as.numeric(sp_index_master)
# ) %>%
# left_join(species_mapping) %>%
# left_join(Stations) -> b_grid_tibble_2
# 
# saveRDS(b_grid_tibble_2, here("data", "b_grid_tibble_2_rpkn.RDS"))

b_grid_tibble_2 <-readRDS(file = here("data", "b_grid_tibble_2_rpkn.RDS"))

b_grid_tibble_2 %>%
mutate(
.,
MHW = case_when(
Year == "2014" ~ "MHW",
Year == "2015" ~ "MHW",
Year == "2016" ~ "MHW",
Year == "2017" ~ "MHW",
Year == "2018" ~ "MHW",
Year == "2019" ~ "MHW",
TRUE ~ "Before"
)
) %>%
mutate(., log_est = log(est + 0.01)) %>%
group_by(ID_master, MHW, id) %>%
dplyr::summarise(mean_b_est_log = mean(log_est),
mean_b_est = mean(est)) -> b_master_dist_out

b_master_dist_out %>% pivot_wider(
values_from = c(mean_b_est_log, mean_b_est),
names_glue = "{MHW}_{.value}",
names_from = MHW
) %>%
mutate(., `MHW-Before` = MHW_mean_b_est - Before_mean_b_est) -> b_master_dist_out
```

### MHW - Site
```{r}
b_grid_tibble_2 %>%
  mutate(
  .,
  MHW = case_when(
  Year == "2014" ~ "MHW",
  Year == "2015" ~ "MHW",
  Year == "2016" ~ "MHW",
  Year == "2017" ~ "MHW",
  Year == "2018" ~ "MHW",
  Year == "2019" ~ "MHW",
  TRUE ~ "Before"
  )
  ) %>%
  mutate(., log_est = log(est + 0.01)) %>%
  group_by(ID_master, MHW, id, station) %>%
  dplyr::summarise(mean_b_est = mean(log_est)) -> b_master_dist_out_station
  
  b_master_dist_out_station %>% pivot_wider(values_from = mean_b_est, names_from =
  MHW) %>%
  mutate(., `MHW-Before` = MHW - Before) -> b_master_dist_out_station
```




#SST Comparisons

## Binomial

### Site - Binomial vs. SST

##### Binomial | Station Run models
```{r}
# model_holder <- tibble(test_nest_a$ID_master)
# model_holder$model <- list(0)
# 
# for (i in 1:nrow(model_holder)) {
# print(i)
# model_holder$model[[i]] <-
# stan_glmer(
# PA_biomass ~ 0 + (1 + temp_std | station),
# #mod3
# family = "binomial",
# data = test_nest_a$data[[i]],
# prior = normal(0, 4),
# 
# prior_intercept = normal(0, 10),
# #adapt_delta = 0.99,
# chains = 2,
# iter = 1000
# )
# }
# 
# saveRDS(model_holder, here("data", "model_holder_20210909.RDS"))

model_holder <- readRDS(here("data","model_holder_20210909.RDS"))
```

##### Look at the models

Example Triphoturus mexicanus
```{r}
focalTaxon = "Triphoturus mexicanus"
idx = which(test_nest_a$ID_master == focalTaxon)

test_nest_a$data[[idx]] %>%
ggplot(aes(y = PA_biomass, x = temp_std)) +
geom_point(color = "black") +
#geom_smooth(method = "glm", method.args = list(family = "binomial"), se = F) +
geom_point(
aes(y = model_holder$model[[idx]]$fitted.values, x = temp_std),
alpha = .5,
color = "red"
) +
geom_smooth(
aes(y = model_holder$model[[idx]]$fitted.values, x = temp_std),
method = "glm",
method.args = list(family = "binomial"),
se = F,
size = 0.5,
color = "red"
) +
facet_grid( ~ station)

```


```{r}
model_coeff_holder <- tibble(test_nest_a$ID_master)
model_coeff_holder$model <- list(0)

i = 1
model_coeff_holder <-
as_tibble(as.list(
c(
model_holder$model[[i]]$coefficients %>% as_tibble(rownames = "Coeff")  %>%
pivot_wider(
names_from = Coeff,
names_glue = "{Coeff}_Coeff",
values_from = c(value)
),
model_holder$model[[i]]$ses %>% as_tibble(rownames = "ses")  %>%
pivot_wider(
names_from = ses,
names_glue = "{ses}_ses",
values_from = c(value)
),
posterior_interval(model_holder$model[[i]], regex_pars = "b") %>%  as.data.frame() %>%  as_tibble(rownames = "Coeff") %>%
pivot_wider(
names_from = Coeff,
names_glue = "{Coeff}_{.value}",
values_from = c(`5%`, `95%`)
)
)
))

for (i in 2:length(unique(test_nest_a$ID_master))) {
model_coeff_holder %>%
bind_rows(as_tibble(as.list(
c(
model_holder$model[[i]]$coefficients %>% as_tibble(rownames = "Coeff")  %>%
pivot_wider(
names_from = Coeff,
names_glue = "{Coeff}_Coeff",
values_from = c(value)
),
model_holder$model[[i]]$ses %>% as_tibble(rownames = "ses")  %>%
pivot_wider(
names_from = ses,
names_glue = "{ses}_ses",
values_from = c(value)
),
posterior_interval(model_holder$model[[i]], regex_pars = "b") %>%  as.data.frame() %>%  as_tibble(rownames = "Coeff") %>%
pivot_wider(
names_from = Coeff,
names_glue = "{Coeff}_{.value}",
values_from = c(`5%`, `95%`)
)
)
))) -> model_coeff_holder
}

model_coeff_holder$ID_master = test_nest_a$ID_master

model_coeff_holder %>%
select(
ID_master,
`b[(Intercept) station:80_60]_Coeff` ,
`b[temp_std station:80_60]_Coeff`    ,
`b[(Intercept) station:86.7_50]_Coeff`,
`b[temp_std station:86.7_50]_Coeff`  ,
`b[(Intercept) station:93.3_30]_Coeff`,
`b[temp_std station:93.3_30]_Coeff`   ,
`b[(Intercept) station:93.3_60]_Coeff`,
`b[temp_std station:93.3_60]_Coeff`
) %>%
pivot_longer(
cols = c(
"b[(Intercept) station:80_60]_Coeff" ,
"b[temp_std station:80_60]_Coeff"    ,
"b[(Intercept) station:86.7_50]_Coeff",
"b[temp_std station:86.7_50]_Coeff"  ,
"b[(Intercept) station:93.3_30]_Coeff",
"b[temp_std station:93.3_30]_Coeff"   ,
"b[(Intercept) station:93.3_60]_Coeff",
"b[temp_std station:93.3_60]_Coeff"
),
names_to = "Coeff_name",
values_to = "Coeff_value"
) -> coeff1

model_coeff_holder %>%
select(
`b[(Intercept) station:80_60]_ses` ,
`b[temp_std station:80_60]_ses`    ,
`b[(Intercept) station:86.7_50]_ses`,
`b[temp_std station:86.7_50]_ses`  ,
`b[(Intercept) station:93.3_30]_ses`,
`b[temp_std station:93.3_30]_ses`   ,
`b[(Intercept) station:93.3_60]_ses`,
`b[temp_std station:93.3_60]_ses`
) %>%
pivot_longer(
cols = c(
"b[(Intercept) station:80_60]_ses" ,
"b[temp_std station:80_60]_ses"    ,
"b[(Intercept) station:86.7_50]_ses",
"b[temp_std station:86.7_50]_ses"  ,
"b[(Intercept) station:93.3_30]_ses",
"b[temp_std station:93.3_30]_ses"   ,
"b[(Intercept) station:93.3_60]_ses",
"b[temp_std station:93.3_60]_ses"
),
names_to = "ses_name",
values_to = "ses_value"
) -> ses1

model_coeff_holder %>%
select(
`b[(Intercept) station:80_60]_5%` ,
`b[temp_std station:80_60]_5%`    ,
`b[(Intercept) station:86.7_50]_5%`,
`b[temp_std station:86.7_50]_5%`  ,
`b[(Intercept) station:93.3_30]_5%`,
`b[temp_std station:93.3_30]_5%`   ,
`b[(Intercept) station:93.3_60]_5%`,
`b[temp_std station:93.3_60]_5%`
) %>%
pivot_longer(
cols = c(
"b[(Intercept) station:80_60]_5%" ,
"b[temp_std station:80_60]_5%"    ,
"b[(Intercept) station:86.7_50]_5%",
"b[temp_std station:86.7_50]_5%"  ,
"b[(Intercept) station:93.3_30]_5%",
"b[temp_std station:93.3_30]_5%"   ,
"b[(Intercept) station:93.3_60]_5%",
"b[temp_std station:93.3_60]_5%"
),
names_to = "5%_name",
values_to = "5%_value"
) -> five1

model_coeff_holder %>%
select(
`b[(Intercept) station:80_60]_95%` ,
`b[temp_std station:80_60]_95%`    ,
`b[(Intercept) station:86.7_50]_95%`,
`b[temp_std station:86.7_50]_95%`  ,
`b[(Intercept) station:93.3_30]_95%`,
`b[temp_std station:93.3_30]_95%`   ,
`b[(Intercept) station:93.3_60]_95%`,
`b[temp_std station:93.3_60]_95%`
) %>%
pivot_longer(
cols = c(
"b[(Intercept) station:80_60]_95%" ,
"b[temp_std station:80_60]_95%"    ,
"b[(Intercept) station:86.7_50]_95%",
"b[temp_std station:86.7_50]_95%"  ,
"b[(Intercept) station:93.3_30]_95%",
"b[temp_std station:93.3_30]_95%"   ,
"b[(Intercept) station:93.3_60]_95%",
"b[temp_std station:93.3_60]_95%"
),
names_to = "95%_name",
values_to = "95%_value"
) -> ninetyfive1

cbind(coeff1, ses1, five1, ninetyfive1) %>%  as_tibble() %>%
mutate(
.,
T_statistic = Coeff_value / ses_value,
Signficant = case_when(
`5%_value` > 0 & `95%_value` > 0 ~ "+",
`5%_value` < 0 & `95%_value` < 0 ~ "-",
TRUE ~ ""
),
station = case_when(
str_detect(Coeff_name, "station:80_60") ~ "Pt. Conception",
str_detect(Coeff_name, "station:86.7_50") ~ "San Nicholas Island",
str_detect(Coeff_name, "station:93.3_30") ~ "San Diego Inshore",
str_detect(Coeff_name, "station:93.3_60") ~ "San Diego Offshore",
TRUE ~ "NA"
)
) -> bionmial_station_model_df

bionmial_station_model_df %>%
filter(., str_detect(Coeff_name, "temp_std")) %>%
filter(., Signficant != "") -> species_to_keep_fig1
```

##### Binomial Site Fig
```{r}
bionmial_station_model_df %>%
  filter(., ID_master %in% species_to_keep_fig1$ID_master) %>%
  filter(., str_detect(Coeff_name, "temp_std")) %>%
  ggplot(., aes(x = station, y = ID_master, fill = T_statistic)) + geom_tile()  + scale_fill_distiller(palette = "Spectral") + geom_text(aes(label =
  Signficant)) + ylab("Species") + xlab("Station") + theme_bw() -> binomial_site_fig
  
  binomial_site_fig
  
  ggsave(
  binomial_site_fig,
  file = here::here("analysis", "figures", "binomial_site_fig.png"),
  width = 12,
  height = 8
  )

```

### Year - Binomial vs. SST

##### Binomial All Run models
```{r}
# 
# 
# model_holder2 <- tibble(test_nest_a$ID_master)
# model_holder2$model <- list(0)
# 
# for (i in 1:nrow(model_holder2)) {
# print(i)
# model_holder2$model[[i]] <-
# stan_glm(
# PA_biomass ~ temp_std ,
# #mod3
# family = "binomial",
# data = test_nest_a$data[[i]],
# prior = normal(0, 4),
# prior_intercept = normal(0, 10),
# #adapt_delta = 0.99,
# chains = 2,
# iter = 1000
# )
# }
# 
# saveRDS(model_holder2,
# here("data", "model_holder_binomial_sst_only_20210909.RDS"))
model_holder2 <-
readRDS(here("data", "model_holder_binomial_sst_only_20210909.RDS"))

good_model <- tibble(model_holder2$`test_nest_a$ID_master`)
good_model$good_model <- list(0)
i = 1
for (i in 1:nrow(model_holder2)) {
good_model$good_model[[i]] <- model_holder2$model[[i]] %>% class()
}

good_model %>%
filter(., good_model != "list") %>%
filter(., good_model != "0") -> models_to_keep
```



##### Look at the model output
```{r}
i = 1
model_holder2 %>%
filter(
.,
`test_nest_a$ID_master` %in% models_to_keep$`model_holder2$\`test_nest_a$ID_master\``
) -> model_holder2

model_coeff_holder_sst <-
as_tibble(as.list(
c(
model_holder2$model[[i]]$coefficients %>% as_tibble(rownames = "Coeff")  %>%
pivot_wider(
names_from = Coeff,
names_glue = "{Coeff}_Coeff",
values_from = c(value)
),
model_holder2$model[[i]]$ses %>% as_tibble(rownames = "ses")  %>%
pivot_wider(
names_from = ses,
names_glue = "{ses}_ses",
values_from = c(value)
),
posterior_interval(model_holder2$model[[i]]) %>%  as.data.frame() %>%  as_tibble(rownames = "Coeff") %>%
pivot_wider(
names_from = Coeff,
names_glue = "{Coeff}_{.value}",
values_from = c(`5%`, `95%`)
)
)
))

for (i in 2:length(unique(model_holder2$`test_nest_a$ID_master`))) {
model_coeff_holder_sst %>%
bind_rows(as_tibble(as.list(
c(
model_holder2$model[[i]]$coefficients %>% as_tibble(rownames = "Coeff")  %>%
pivot_wider(
names_from = Coeff,
names_glue = "{Coeff}_Coeff",
values_from = c(value)
),
model_holder2$model[[i]]$ses %>% as_tibble(rownames = "ses")  %>%
pivot_wider(
names_from = ses,
names_glue = "{ses}_ses",
values_from = c(value)
),
posterior_interval(model_holder2$model[[i]]) %>%  as.data.frame() %>%  as_tibble(rownames = "Coeff") %>%
pivot_wider(
names_from = Coeff,
names_glue = "{Coeff}_{.value}",
values_from = c(`5%`, `95%`)
)
)
))) -> model_coeff_holder_sst
}


model_coeff_holder_sst$ID_master = model_holder2$`test_nest_a$ID_master`

model_coeff_holder_sst %>%
select(ID_master, `(Intercept)_Coeff` ,  `temp_std_Coeff`) %>%
pivot_longer(
cols = c("(Intercept)_Coeff" , "temp_std_Coeff"),
names_to = "Coeff_name",
values_to = "Coeff_value"
) -> coeff2

model_coeff_holder_sst %>%
select(`(Intercept)_ses`  , `temp_std_ses`) %>%
pivot_longer(
cols = c("(Intercept)_ses"  , "temp_std_ses"),
names_to = "ses_name",
values_to = "ses_value"
) -> ses2

model_coeff_holder_sst %>%
select(`(Intercept)_5%`,    `temp_std_5%`) %>%
pivot_longer(
cols = c("(Intercept)_5%" ,   "temp_std_5%"),
names_to = "5%_name",
values_to = "5%_value"
) -> five2

model_coeff_holder_sst %>%
select(`(Intercept)_95%`  , `temp_std_95%`) %>%
pivot_longer(
cols = c("(Intercept)_95%"  , "temp_std_95%"),
names_to = "95%_name",
values_to = "95%_value"
) -> ninetyfive2

cbind(coeff2, ses2, five2, ninetyfive2) %>%  as_tibble() %>%
mutate(
.,
T_statistic = Coeff_value / ses_value,
Signficant = case_when(
`5%_value` > 0 & `95%_value` > 0 ~ "+",
`5%_value` < 0 & `95%_value` < 0 ~ "-",
TRUE ~ ""
)
) -> bionmial_sst_model_df
```
##### Binomial Figure
```{r}


bionmial_sst_model_df %>%
filter(., Signficant != "") %>%
mutate(., Temp = "Temperature") %>%
filter(., str_detect(Coeff_name, "temp_std")) %>%
ggplot(., aes(
x = Temp,
y = reorder(ID_master,-T_statistic),
fill = T_statistic
)) + geom_tile()  + scale_fill_distiller(palette = "Spectral") + geom_text(aes(label =
Signficant)) + ylab("Species") + xlab("Binomial Association") + theme_bw() -> binomial_sst_fig

binomial_sst_fig

ggsave(
binomial_sst_fig,
file = here::here("analysis", "figures", "binomial_sst_fig.png"),
width = 12,
height = 8
)

```



## Biomass

### Site - Biomass vs. SST

##### Log Biomass | Station Run models
```{r}
#
# glmer_stan_mod_log <- tibble(test_nest_a$ID_master)
# glmer_stan_mod_log$model <- list(0)
#
# for (i in 1:nrow(glmer_stan_mod_log)){
#   print(i)
#   glmer_stan_mod_log$model[[i]] <- stan_glmer(log_Normalized.biomass ~ 0 + (1 + temp_std | station),   #mod3
#                              family = "gaussian",
#                              data = test_nest_a$data[[i]],
#                              #prior = normal(0, 4),
#                             #prior_intercept = normal(0, 10),
#                              adapt_delta = 0.99,
#                              chains = 2,
#                              iter = 2000,
#                              cores = 2)
# }
#
# saveRDS(glmer_stan_mod_log, here("data","glmer_stan_mod_log_20210909.RDS"))

glmer_stan_mod_log <- readRDS(here("data","glmer_stan_mod_log_20210909.RDS"))

```

##### Look at the models
Explore Triphoturus mexicanus results
```{r}


focalTaxon = "Triphoturus mexicanus"
idx = which(test_nest_a$ID_master == focalTaxon)

test_nest_a$data[[idx]] %>%
ggplot(aes(y = log_Normalized.biomass, x = temp_std)) +
geom_point(color = "black") +
#geom_smooth(method = "glm", method.args = list(family = "binomial"), se = F) +
geom_point(
aes(y = glmer_stan_mod_log$model[[idx]]$fitted.values, x = temp_std),
alpha = .5,
color = "red"
) +
geom_smooth(
aes(y = glmer_stan_mod_log$model[[idx]]$fitted.values, x = temp_std),
method = "lm",
se = F,
size = 0.5,
color = "red"
) +
facet_grid( ~ station)
```




```{r}
log_model_coeff_holder <- tibble(test_nest_a$ID_master)
log_model_coeff_holder$model <- list(0)

i = 1
log_model_coeff_holder <-
as_tibble(as.list(
c(
glmer_stan_mod_log$model[[i]]$coefficients %>% as_tibble(rownames = "Coeff")  %>%
pivot_wider(
names_from = Coeff,
names_glue = "{Coeff}_Coeff",
values_from = c(value)
),
glmer_stan_mod_log$model[[i]]$ses %>% as_tibble(rownames = "ses")  %>%
pivot_wider(
names_from = ses,
names_glue = "{ses}_ses",
values_from = c(value)
),
posterior_interval(glmer_stan_mod_log$model[[i]], regex_pars = "b") %>%  as.data.frame() %>%  as_tibble(rownames = "Coeff") %>%
pivot_wider(
names_from = Coeff,
names_glue = "{Coeff}_{.value}",
values_from = c(`5%`, `95%`)
)
)
))

for (i in 2:length(unique(test_nest_a$ID_master))) {
log_model_coeff_holder %>%
bind_rows(as_tibble(as.list(
c(
glmer_stan_mod_log$model[[i]]$coefficients %>% as_tibble(rownames = "Coeff")  %>%
pivot_wider(
names_from = Coeff,
names_glue = "{Coeff}_Coeff",
values_from = c(value)
),
glmer_stan_mod_log$model[[i]]$ses %>% as_tibble(rownames = "ses")  %>%
pivot_wider(
names_from = ses,
names_glue = "{ses}_ses",
values_from = c(value)
),
posterior_interval(glmer_stan_mod_log$model[[i]], regex_pars = "b") %>%  as.data.frame() %>%  as_tibble(rownames = "Coeff") %>%
pivot_wider(
names_from = Coeff,
names_glue = "{Coeff}_{.value}",
values_from = c(`5%`, `95%`)
)
)
))) -> log_model_coeff_holder
}

log_model_coeff_holder$ID_master = test_nest_a$ID_master

log_model_coeff_holder %>%
select(
ID_master,
`b[(Intercept) station:80_60]_Coeff` ,
`b[temp_std station:80_60]_Coeff`    ,
`b[(Intercept) station:86.7_50]_Coeff`,
`b[temp_std station:86.7_50]_Coeff`  ,
`b[(Intercept) station:93.3_30]_Coeff`,
`b[temp_std station:93.3_30]_Coeff`   ,
`b[(Intercept) station:93.3_60]_Coeff`,
`b[temp_std station:93.3_60]_Coeff`
) %>%
pivot_longer(
cols = c(
"b[(Intercept) station:80_60]_Coeff" ,
"b[temp_std station:80_60]_Coeff"    ,
"b[(Intercept) station:86.7_50]_Coeff",
"b[temp_std station:86.7_50]_Coeff"  ,
"b[(Intercept) station:93.3_30]_Coeff",
"b[temp_std station:93.3_30]_Coeff"   ,
"b[(Intercept) station:93.3_60]_Coeff",
"b[temp_std station:93.3_60]_Coeff"
),
names_to = "Coeff_name",
values_to = "Coeff_value"
) -> coeff3


log_model_coeff_holder %>%
select(
`b[(Intercept) station:80_60]_ses` ,
`b[temp_std station:80_60]_ses`    ,
`b[(Intercept) station:86.7_50]_ses`,
`b[temp_std station:86.7_50]_ses`  ,
`b[(Intercept) station:93.3_30]_ses`,
`b[temp_std station:93.3_30]_ses`   ,
`b[(Intercept) station:93.3_60]_ses`,
`b[temp_std station:93.3_60]_ses`
) %>%
pivot_longer(
cols = c(
"b[(Intercept) station:80_60]_ses" ,
"b[temp_std station:80_60]_ses"    ,
"b[(Intercept) station:86.7_50]_ses",
"b[temp_std station:86.7_50]_ses"  ,
"b[(Intercept) station:93.3_30]_ses",
"b[temp_std station:93.3_30]_ses"   ,
"b[(Intercept) station:93.3_60]_ses",
"b[temp_std station:93.3_60]_ses"
),
names_to = "ses_name",
values_to = "ses_value"
) -> ses3

log_model_coeff_holder %>%
select(
`b[(Intercept) station:80_60]_5%` ,
`b[temp_std station:80_60]_5%`    ,
`b[(Intercept) station:86.7_50]_5%`,
`b[temp_std station:86.7_50]_5%`  ,
`b[(Intercept) station:93.3_30]_5%`,
`b[temp_std station:93.3_30]_5%`   ,
`b[(Intercept) station:93.3_60]_5%`,
`b[temp_std station:93.3_60]_5%`
) %>%
pivot_longer(
cols = c(
"b[(Intercept) station:80_60]_5%" ,
"b[temp_std station:80_60]_5%"    ,
"b[(Intercept) station:86.7_50]_5%",
"b[temp_std station:86.7_50]_5%"  ,
"b[(Intercept) station:93.3_30]_5%",
"b[temp_std station:93.3_30]_5%"   ,
"b[(Intercept) station:93.3_60]_5%",
"b[temp_std station:93.3_60]_5%"
),
names_to = "5%_name",
values_to = "5%_value"
) -> five3

log_model_coeff_holder %>%
select(
`b[(Intercept) station:80_60]_95%` ,
`b[temp_std station:80_60]_95%`    ,
`b[(Intercept) station:86.7_50]_95%`,
`b[temp_std station:86.7_50]_95%`  ,
`b[(Intercept) station:93.3_30]_95%`,
`b[temp_std station:93.3_30]_95%`   ,
`b[(Intercept) station:93.3_60]_95%`,
`b[temp_std station:93.3_60]_95%`
) %>%
pivot_longer(
cols = c(
"b[(Intercept) station:80_60]_95%" ,
"b[temp_std station:80_60]_95%"    ,
"b[(Intercept) station:86.7_50]_95%",
"b[temp_std station:86.7_50]_95%"  ,
"b[(Intercept) station:93.3_30]_95%",
"b[temp_std station:93.3_30]_95%"   ,
"b[(Intercept) station:93.3_60]_95%",
"b[temp_std station:93.3_60]_95%"
),
names_to = "95%_name",
values_to = "95%_value"
) -> ninetyfive3

cbind(coeff3, ses3, five3, ninetyfive3) %>%  as_tibble() %>%
mutate(
.,
T_statistic = Coeff_value / ses_value,
Signficant = case_when(
`5%_value` > 0 & `95%_value` > 0 ~ "+",
`5%_value` < 0 & `95%_value` < 0 ~ "-",
TRUE ~ ""
),
station = case_when(
str_detect(Coeff_name, "station:80_60") ~ "Pt. Conception",
str_detect(Coeff_name, "station:86.7_50") ~ "San_Nick",
str_detect(Coeff_name, "station:93.3_30") ~ "SD_Inshore",
str_detect(Coeff_name, "station:93.3_60") ~ "SD_Offshore",
TRUE ~ "NA"
)
) -> log_station_model_df
```

##### Log Biomass Site Figure
```{r}
log_station_model_df %>%
  filter(., str_detect(Coeff_name, "temp_std")) %>%
  filter(., Signficant != "") -> species_to_keep_fig3
  
  log_station_model_df %>%
  filter(., ID_master %in% species_to_keep_fig3$ID_master) %>%
  filter(., str_detect(Coeff_name, "temp_std")) %>%
  ggplot(., aes(x = station, y = ID_master, fill = T_statistic)) + geom_tile()  + scale_fill_distiller(palette = "Spectral") + geom_text(aes(label =
  Signficant)) + xlab("Station") + ylab("Species") + theme_bw() -> log_biomass_sites_fig
  
  log_biomass_sites_fig
  
  ggsave(
  log_biomass_sites_fig,
  file = here::here("analysis", "figures", "log_biomass_sites_fig.png"),
  width = 12,
  height = 8
  )

```

### Year - Biomass vs. SST

##### Log Biomass Run models
```{r}
# 
# 
# model_holder4 <- tibble(test_nest_a$ID_master)
# model_holder4$model <- list(0)
# 
# for (i in 1:nrow(model_holder4)) {
# print(i)
# model_holder4$model[[i]] <-
# stan_glm(
# log_Normalized.biomass ~ temp_std ,
# #mod3
# family = "gaussian",
# data = test_nest_a$data[[i]],
# #prior = normal(0, 4),
# #prior_intercept = normal(0, 10),
# #adapt_delta = 0.99,
# chains = 2,
# iter = 1000
# )
# }
# 
# saveRDS(model_holder4,
# here("data", "model_holder_biomass_sst_only_20210909.RDS"))
model_holder4 <-
  readRDS(here("data", "model_holder_biomass_sst_only_20210909.RDS"))
  
  good_model <- tibble(model_holder4$`test_nest_a$ID_master`)
  good_model$good_model <- list(0)
  
  for (i in 1:nrow(model_holder4)) {
  good_model$good_model[[i]] <- model_holder4$model[[i]] %>% class()
  }
  
  good_model %>%
  filter(., good_model != "list") %>%
  filter(., good_model != "0") -> models_to_keep
```

### Look at the model output
```{r}
i = 1
model_holder4 %>%
filter(
.,
`test_nest_a$ID_master` %in% models_to_keep$`model_holder4$\`test_nest_a$ID_master\``
) -> model_holder4


model_coeff_holder4_sst <-
as_tibble(as.list(
c(
model_holder4$model[[i]]$coefficients %>% as_tibble(rownames = "Coeff")  %>%
pivot_wider(
names_from = Coeff,
names_glue = "{Coeff}_Coeff",
values_from = c(value)
),
model_holder4$model[[i]]$ses %>% as_tibble(rownames = "ses")  %>%
pivot_wider(
names_from = ses,
names_glue = "{ses}_ses",
values_from = c(value)
),
posterior_interval(model_holder4$model[[i]]) %>%  as.data.frame() %>%  as_tibble(rownames = "Coeff") %>%
pivot_wider(
names_from = Coeff,
names_glue = "{Coeff}_{.value}",
values_from = c(`5%`, `95%`)
)
)
))

for (i in 2:length(unique(model_holder4$`test_nest_a$ID_master`))) {
model_coeff_holder4_sst %>%
bind_rows(as_tibble(as.list(
c(
model_holder4$model[[i]]$coefficients %>% as_tibble(rownames = "Coeff")  %>%
pivot_wider(
names_from = Coeff,
names_glue = "{Coeff}_Coeff",
values_from = c(value)
),
model_holder4$model[[i]]$ses %>% as_tibble(rownames = "ses")  %>%
pivot_wider(
names_from = ses,
names_glue = "{ses}_ses",
values_from = c(value)
),
posterior_interval(model_holder4$model[[i]]) %>%  as.data.frame() %>%  as_tibble(rownames = "Coeff") %>%
pivot_wider(
names_from = Coeff,
names_glue = "{Coeff}_{.value}",
values_from = c(`5%`, `95%`)
)
)
))) -> model_coeff_holder4_sst
}


model_coeff_holder4_sst$ID_master = model_holder4$`test_nest_a$ID_master`

model_coeff_holder4_sst %>%
select(ID_master, `(Intercept)_Coeff` ,  `temp_std_Coeff`) %>%
pivot_longer(
cols = c("(Intercept)_Coeff" , "temp_std_Coeff"),
names_to = "Coeff_name",
values_to = "Coeff_value"
) -> coeff4

model_coeff_holder4_sst %>%
select(`(Intercept)_ses`  , `temp_std_ses`) %>%
pivot_longer(
cols = c("(Intercept)_ses"  , "temp_std_ses"),
names_to = "ses_name",
values_to = "ses_value"
) -> ses4

model_coeff_holder4_sst %>%
select(`(Intercept)_5%`,    `temp_std_5%`) %>%
pivot_longer(
cols = c("(Intercept)_5%" ,   "temp_std_5%"),
names_to = "5%_name",
values_to = "5%_value"
) -> five4

model_coeff_holder4_sst %>%
select(`(Intercept)_95%`  , `temp_std_95%`) %>%
pivot_longer(
cols = c("(Intercept)_95%"  , "temp_std_95%"),
names_to = "95%_name",
values_to = "95%_value"
) -> ninetyfive4

cbind(coeff4, ses4, five4, ninetyfive4) %>%  as_tibble() %>%
mutate(
.,
T_statistic = Coeff_value / ses_value,
Signficant = case_when(
`5%_value` > 0 & `95%_value` > 0 ~ "+",
`5%_value` < 0 & `95%_value` < 0 ~ "-",
TRUE ~ ""
)
) -> log_sst_model_df
```

##### Log Biomass Figure
```{r}


log_sst_model_df %>%
mutate(., Temp = "Temperature") %>%
filter(., str_detect(Coeff_name, "temp_std")) %>%
ggplot(., aes(
x = Temp,
y = reorder(ID_master,-T_statistic),
fill = T_statistic
)) + geom_tile()  + scale_fill_distiller(palette = "Spectral") + geom_text(aes(label =
Signficant)) + xlab("Biomass Association") + ylab("Species") +
theme(
axis.text.x = element_text(
size = 14,
angle = 30,
hjust = 1
),
panel.background = element_rect(fill = 'white', colour = 'white'),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text.y = element_text(size = 14, angle = 0),
axis.title.x = element_blank(),
axis.title.y = element_text(size = 18, angle = 90, face = "bold"),
strip.background = element_rect(fill = 'white'),
strip.text.x = element_text(size = 15),
legend.text = element_text(size = 10),
legend.title = element_text(size = 15),
axis.line = element_line(colour = 'black')
) + labs(fill = expression(atop(
"Slope Log Biomass vs. SST /", paste(" Standard Error")
))) -> log_biomass_sst_fig

log_biomass_sst_fig

ggsave(
log_biomass_sst_fig,
file = here::here("analysis", "figures", "log_biomass_sst_fig.png"),
width = 12,
height = 8
)



```

### Organize data 
```{r}

log_sst_model_df %>% 
  mutate(., Temp = "Temperature") %>% 
  filter(., str_detect(Coeff_name,"temp_std")) %>%
  arrange(desc(T_statistic)) %>% 
  left_join(trait_edna, by=c("ID_master")) %>%  dplyr::select(ID_master,Type,species_color)-> color_trait

color_trait %>%  filter(is.na(Type))

log_sst_model_df %>% 
    left_join(trait_edna, by=c("ID_master"))-> log_sst_model_df2

log_sst_model_df2$Type <- as.character(log_sst_model_df2$Type)
log_sst_model_df2$Type <- factor(log_sst_model_df2$Type, levels=c("Benthic North" ,"Benthic Central","Benthic Cosmopolitan","Benthic South", "Coastal Pelagic North", "Coastal Pelagic Central","Mesopelagic North","Mesopelagic Central" , "Mesopelagic Cosmopolitan"  ,"Mesopelagic South"))

trait_edna %>% 
  group_by(Type) %>%  count() %>%  filter(., n > 3) -> type_to_plot

log_sst_model_df2 %>% dplyr::select(Type, species_color) %>%  distinct() -> trait_color_pallete

trait_color_pallete -> trait_color_pallete_v2
trait_color_pallete %>%  filter(., Type %in% type_to_plot$Type) %>% arrange(Type) -> trait_color_pallete

```





##### Log Biomass Figure Barplot
```{r}

log_sst_model_df %>% 
    mutate(., Temp = "Temperature") %>% 
  left_join(color_trait) %>% 
  filter(., str_detect(Coeff_name,"temp_std")) -> log_sst_model_df_plot

log_sst_model_df_plot %>%
  ggplot(., aes(y=T_statistic, x = reorder(ID_master, -T_statistic), fill =Type)) +  geom_bar(position="stack", stat="identity")  + scale_fill_manual(values=palette.new$color) + geom_text(aes(label=Signficant, y = T_statistic + 0.2 * sign(T_statistic))) + xlab("Species") + ylab(expression(atop("Slope Log Biomass vs. SST /", paste(" Standard Error")))) +  
  theme(axis.text.x = element_text(size=14,angle= 30, hjust= 1), 
        panel.background = element_rect(fill='white', colour='white'),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          axis.text.y=element_text(size=14, angle=0,colour = color_trait$species_color), 
          axis.title.x=element_blank(), 
          axis.title.y=element_text(size=18, angle=90,face="bold"),
          strip.background = element_rect(fill='white'), 
          strip.text.x=element_text(size=15),
          legend.text=element_text(size=10),
          legend.title=element_text(size=15),
          axis.line=element_line(colour='black')) + labs(fill="Habitat Association")-> log_biomass_sst_fig_v2
log_biomass_sst_fig_v2

ggsave(log_biomass_sst_fig_v2, file =here::here("analysis","figures","log_biomass_sst_fig_v2.png"), width = 12, height = 8)

```

## Focal Species

#Binomial Fit
### Mexican Lampfish

```{r}


focalTaxon = "Triphoturus mexicanus"
idx = which(test_nest_a$ID_master == focalTaxon)
test_nest_a$data[[idx]]$ID_master <- "Mexican Lampfish"

model_holder2$`test_nest_a$ID_master`
test_nest_a$data[[idx]] %>%
  data_grid(temp_std = seq_range(temp_std, n = 51)) %>%
  add_fitted_draws(model_holder2$model[[55]]) %>%
  ggplot(aes(x = (temp_std * 1.37 + 14.5), y = PA_biomass)) +
  stat_lineribbon(aes(y = .value), color="darkred") +
  geom_point(data = test_nest_a$data[[idx]], color = "darkred") +
  scale_fill_brewer(palette = "Reds") +
  scale_color_brewer(palette = "Set2") +
  theme(axis.text.x = element_text(size=14), 
        panel.background = element_rect(fill='white', colour='white'),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          axis.text.y=element_text(size=14, angle=0), 
          axis.title.x=element_text(size=18, angle=0,face="bold"), 
          axis.title.y=element_text(size=18, angle=90,face="bold"),
          strip.background = element_rect(fill='grey90'), 
          strip.text.x=element_text(size=15),
          legend.text=element_text(size=10),
          legend.title=element_text(size=15),
          axis.line=element_line(colour='black'))	+ xlab("T ˚C") + ylab("Occurrence") + labs(fill='Confidence Interval') +
  facet_wrap(~ID_master) -> T_mex_binomial_fig
T_mex_binomial_fig


saveRDS(T_mex_binomial_fig, file =here::here("analysis","figures","T_mex_binomial_fig.RDS"))

ggsave(T_mex_binomial_fig, file =here::here("analysis","figures","T_mex_binomial_fig.png"), width = 14, height = 8)


```
### Stenobrachius nannocir

```{r}


focalTaxon = "Stenobrachius nannochir"
idx = which(test_nest_a$ID_master == focalTaxon)
test_nest_a$data[[idx]]$ID_master <- "Northern Lampfish - Cold Variant"
model_holder2$`test_nest_a$ID_master`[[48]]
test_nest_a$data[[idx]] %>%
  data_grid(temp_std = seq_range(temp_std, n = 51)) %>%
  add_fitted_draws(model_holder2$model[[48]]) %>%
  ggplot(aes(x = (temp_std * 1.37 + 14.5), y = PA_biomass)) +
  stat_lineribbon(aes(y = .value), color="navy") +
  geom_point(data = test_nest_a$data[[idx]], color = "navy") +
  scale_fill_brewer(palette = "Blues") +
  scale_color_brewer(palette = "Set2") +
  theme(axis.text.x = element_text(size=14), 
        panel.background = element_rect(fill='white', colour='white'),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          axis.text.y=element_text(size=14, angle=0), 
          axis.title.x=element_text(size=18, angle=0,face="bold"), 
          axis.title.y=element_text(size=18, angle=90,face="bold"),
          strip.background = element_rect(fill='grey90'), 
          strip.text.x=element_text(size=15),
          legend.text=element_text(size=10),
          legend.title=element_text(size=15),
          axis.line=element_line(colour='black'))	+ xlab("T ˚C") + ylab("Occurrence") + labs(fill='Confidence Interval') +
  facet_wrap(~ID_master) -> garnet_binomial_fig

garnet_binomial_fig

saveRDS(garnet_binomial_fig, file =here::here("analysis","figures","garnet_binomial_fig.RDS"))

ggsave(garnet_binomial_fig, file =here::here("analysis","figures","garnet_binomial_fig.png"), width = 14, height = 8)


```


# Biomass Fit
## Anchovy and Sardine
```{r}
b_master_out_site %>% 
 subset(., ID_master %in% c("Engraulis mordax","Sardinops sagax")) %>% 
  mutate(.,Species= fct_recode(ID_master,
   "Northern Anchovy"= "Engraulis mordax" , "Pacific Sardine"= "Sardinops sagax" ), Year=as.numeric(Year)) -> b_long_all_edit

b_long_all_edit %>% 
  group_by(Year, Species) %>% 
  dplyr::summarise(abundance = mean(median), max_abundance = max(median), min_abundance = min(median)) %>% 
  mutate(., mean_log = log(abundance+0.1), max_log = log(max_abundance+0.1), min_log = log(min_abundance+0.1)) -> b_long_all_edit

biomass1 <- ggplot(data=b_long_all_edit, aes(x=Year, group=Species, color=Species)) + 
  scale_color_manual(values=c("navy","darkred")) +
  geom_point(aes(y=`mean_log`),size=2, na.rm = TRUE) +
  geom_line(aes(y=`mean_log`),size=0.5, na.rm = TRUE) +
  geom_errorbar(aes(ymin = min_log, ymax = max_log), width = 0.1)+
  #annotate("rect", xmin = 2014, xmax = 2019, ymin = -500, ymax = 3000, alpha = .2,fill = "darkred")+
  annotate("rect", xmin = 2014, xmax = 2019, ymin = -3, ymax = 10, alpha = .2,fill = "darkred")+
  theme_bw() +		## makes background white
  theme(  panel.background = element_rect(fill='white', colour='white'),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          axis.text.x=element_text(size=10, angle=20, hjust = 0.65), 
          axis.text.y=element_text(size=12, angle=0), 
          axis.title.x=element_text(size=16, angle=0,face="bold"), 
          axis.title.y=element_text(size=16, angle=90,face="bold"),
          strip.background = element_rect(fill='grey90'), 
          strip.text.x=element_text(size=14, face='italic'),
          legend.text=element_text(size=12),
          legend.position = c(0.2, 0.85),
          legend.title = element_blank(),
         legend.box = "vertical") + ylab("log(Abundance)")
biomass1


ggsave(biomass1, file =here::here("analysis","figures","anchovy_sardine_time_averaged.png"), width = 12, height = 8)

```

## Anchovy and Sardine -Site
```{r}
b_master_out_site %>% 
 subset(., ID_master %in% c("Engraulis mordax","Sardinops sagax")) %>% 
  mutate(.,Species= fct_recode(ID_master,
   "Northern Anchovy"= "Engraulis mordax" , "Pacific Sardine"= "Sardinops sagax" ), Year=as.numeric(Year)) %>% 
  mutate(., station= fct_recode(station,
   "Pt. Conception"=  "80_60" , "San Nicholas Island"= "86.7_50" , "San Diego Inshore"="93.3_30", "San Diego Offshore"= "93.3_60")) -> b_long_all_edit

b_long_all_edit %>% 
  mutate(., median_log = log(median+0.1),sd_log = log(sd+0.1),p05_log = log(p05+0.1),p95_log = log(p95+0.1) ) -> b_long_all_edit_site

ggplot(data=b_long_all_edit_site, aes(x=Year, group=Species, color=Species)) + 
  scale_color_manual(values=c("navy","darkred")) +
  geom_point(aes(y=`median_log`),size=2, na.rm = TRUE) +
  geom_line(aes(y=`median_log`),size=0.5, na.rm = TRUE) +
  geom_errorbar(aes(ymin = p05_log, ymax = p95_log), width = 0.1) +
  facet_wrap(station~., ncol=1) +theme_bw() +		## makes background white
  theme(  panel.background = element_rect(fill='white', colour='white'),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          axis.text.x=element_text(size=10, angle=20, hjust = 0.65), 
          axis.text.y=element_text(size=12, angle=0), 
          axis.title.x=element_text(size=16, angle=0,face="bold"), 
          axis.title.y=element_text(size=16, angle=90,face="bold"),
          strip.background = element_rect(fill='grey90'), 
          strip.text.x=element_text(size=14, face='italic'),
          legend.text=element_text(size=12),
          legend.title = element_blank(),
         legend.box = "vertical") + ylab("log(Abundance)")+ annotate("rect", xmin = 2014, xmax = 2019, ymin = -3, ymax = 10, alpha = .2,fill = "darkred")-> biomass_site_chovy_sard
biomass_site_chovy_sard

ggsave(biomass_site_chovy_sard, file =here::here("analysis","figures","anchovy_sardine_time_facet.png"), width = 14, height = 8)


```

```{r}
b_long_all_edit_site %>% 
  filter(., station ==  "Pt. Conception") -> b_long_all_edit_site_conception


  biomass_conc <- ggplot(data=b_long_all_edit_site_conception, aes(x=Year, group=Species, color=Species)) + 
  scale_color_manual(values=c("navy","darkred")) +
  geom_point(aes(y=`median_log`),size=2, na.rm = TRUE) +
  geom_line(aes(y=`median_log`),size=0.5, na.rm = TRUE) +
  geom_errorbar(aes(ymin = p05_log, ymax = p95_log), width = 0.1)+
  #annotate("rect", xmin = 2014, xmax = 2019, ymin = -500, ymax = 3000, alpha = .2,fill = "darkred")+
  annotate("rect", xmin = 2014, xmax = 2019, ymin = -3, ymax = 10, alpha = .2,fill = "darkred")+
  theme_bw() +		## makes background white
  theme(  panel.background = element_rect(fill='white', colour='white'),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          axis.text.x=element_text(size=10, angle=20, hjust = 0.65), 
          axis.text.y=element_text(size=12, angle=0), 
          axis.title.x=element_text(size=16, angle=0,face="bold"), 
          axis.title.y=element_text(size=16, angle=90,face="bold"),
          strip.background = element_rect(fill='grey90'), 
          strip.text.x=element_text(size=14, face='italic'),
          legend.text=element_text(size=12),
          legend.position = c(0.2, 0.85),
          legend.title = element_blank(),
         legend.box = "vertical") + ylab("log(Abundance)")
biomass_conc


ggsave(biomass_conc, file =here::here("analysis","figures","anchovy_sardine_time_pt.conception.png"), width = 14, height = 8)

```


# Box Plots

### Biogeographic Region

```{r}

log_sst_model_df2 %>% 
  filter(., str_detect(Coeff_name,"temp_std"))  %>% 
  filter(., Type %in% type_to_plot$Type) %>% 
  ggplot(., aes(y= Coeff_value, x = Type, fill=Type)) +
  geom_hline(yintercept = 0, linetype =2)+
  geom_boxplot() + scale_fill_manual(values= pallete.fib1b$color) +  
  theme(axis.text.x = element_text(size=14,angle= 50, hjust= 1), 
        panel.background = element_rect(fill='white', colour='white'),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          axis.text.y=element_text(size=14, angle=0), 
          axis.title.x=element_text(size=18, angle=0, face="bold"), 
          axis.title.y=element_text(size=18, angle=90,face="bold"),
          strip.background = element_rect(fill='white'), 
          strip.text.x=element_text(size=15),
          legend.text=element_text(size=10),
          legend.title=element_text(size=15),
          axis.line=element_line(colour='black'),
          legend.position="none")	+ xlab("Habitat Association") + ylab("Log(Abundance)/˚C") -> habitat_association_fig_all

habitat_association_fig_all

ggsave(habitat_association_fig_all, file =here::here("analysis","figures","habitat_association_fig_all.png"), width = 14, height = 8)

```

# MHW Comparisons

### Averaged Across Sites

```{r}
b_master_dist_out  -> b_MHW

b_MHW %>% 
  group_by(ID_master) %>% 
  dplyr::summarise(mean=mean(`MHW-Before`), median=median(`MHW-Before`),sd=sd(`MHW-Before`), p05= quantile(`MHW-Before`, probs=0.05), p95= quantile(`MHW-Before`, probs=0.95)) -> MHW_species_summary
  
MHW_species_summary %>% 
  mutate(., Sig_MHW = case_when(p05 > 0 & mean > 0 & p95 > 0 ~"+",
                                p05 < 0 & mean < 0 & p95 < 0 ~"-",
                                TRUE ~"")) %>% 
  filter(., Sig_MHW != "")-> MHW_species_summary_sig

MHW_species_summary_sig %>% 
     left_join(trait_edna, by=c("ID_master")) %>% 
  arrange(desc(mean)) %>%  dplyr::select(species_color) -> MHW_species_summary_sig_colors


MHW_species_summary_sig %>%
  left_join(trait_edna) -> MHW_species_summary_sig

MHW_species_summary_sig %>% 
  dplyr::select(Type, species_color) %>%  unique()-> species_color_mhw


species_color_mhw$Type <- as.character(species_color_mhw$Type)
species_color_mhw$Type <- factor(species_color_mhw$Type, levels=c("Benthic North" ,"Benthic Central","Benthic Cosmopolitan","Benthic South", "Coastal Pelagic North", "Coastal Pelagic Central","Mesopelagic North","Mesopelagic Central" , "Mesopelagic Cosmopolitan"  ,"Mesopelagic South"))

species_color_mhw %>% arrange(Type) -> species_color_mhw

MHW_species_summary_sig$Type <- as.character(MHW_species_summary_sig$Type)
MHW_species_summary_sig$Type <- factor(MHW_species_summary_sig$Type, levels=c("Benthic North" ,"Benthic Central","Benthic Cosmopolitan","Benthic South", "Coastal Pelagic North", "Coastal Pelagic Central","Mesopelagic North","Mesopelagic Central" , "Mesopelagic Cosmopolitan"  ,"Mesopelagic South"))




MHW_species_summary_sig %>% 
  ggplot(., aes(y= mean, x= reorder(ID_master, -mean), fill=Type)) +  geom_bar(position="stack", stat="identity") +
  scale_fill_manual( values = palette.new3$color) + ylab(expression(Delta*"Abundance")) + guides(fill=guide_legend(title="Habitat Association")) + scale_y_continuous(trans = pseudolog10_trans, breaks = c(-40, 0,40,80,400 )) +
  theme(axis.text.x = element_text(size=12,angle= 45, hjust= 1), 
        panel.background = element_rect(fill='white', colour='white'),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          axis.text.y=element_text(size=16, angle=0), 
          axis.title.x=element_blank(), 
          axis.title.y=element_text(size=20, angle=90,face="bold"),
          strip.background = element_rect(fill='white'), 
          strip.text.x=element_text(size=15),
          legend.text=element_text(size=16),
          legend.title=element_text(size=18),
          axis.line=element_line(colour='black'), 
        legend.position = c(0.9, 0.7) )   -> mhw_differential_abundance
mhw_differential_abundance

ggsave(mhw_differential_abundance, file =here::here("analysis","figures","mhw_differential_abundance.png"), width = 12, height = 8)

```


# Figure Sum Habitat vs. Temp

```{r}
b_master_out_type$Year <- as.numeric(b_master_out_type$Year)
b_master_out_type$Type <- factor(b_master_out_type$Type, levels=c("Benthic North" ,"Benthic Central","Benthic Cosmopolitan","Benthic South", "Coastal Pelagic North", "Coastal Pelagic Central","Mesopelagic North","Mesopelagic Central" , "Mesopelagic Cosmopolitan"  ,"Mesopelagic South"))

b_master_out_type %>% 
  left_join(two_month_sst_mean) %>%
  filter(., Type =="Mesopelagic South") %>% 
  ggplot(., aes(y=log_sum, x=mean_two_month_sst, colour=Type, fill = Type, group=Type)) +geom_point() +geom_smooth(method="lm") +facet_wrap(.~Type) + scale_fill_manual(values="#B40F20") + scale_colour_manual(values="#B40F20") +
  stat_poly_eq(formula = y~x, 
                aes(label = paste(..rr.label..,..p.value.label.., sep = "~~~")), 
                parse = TRUE,
               label.x = 1.5,
  label.y = 0.1, p.digits =2, rr.digits = 2,size = 7) +
  theme( panel.background = element_rect(fill='white', colour='white'),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          axis.text.x=element_text(size=12, angle=0), 
          axis.text.y=element_text(size=12, angle=0), 
          axis.title.x=element_text(size=16, angle=0,face="bold"), 
          axis.title.y=element_text(size=16, angle=90,face="bold"),
          strip.background = element_rect(fill='grey90'), 
          strip.text.x=element_text(size=14, face='italic'),
          legend.text=element_text(size=10),
          legend.title=element_text(size=15),
         axis.line=element_line(colour='black'),
         legend.position = "none") + xlab("SST (˚C)") + ylab("Log(Abundance)")  -> sum_habitat_temp_regression 
sum_habitat_temp_regression


ggsave(sum_habitat_temp_regression, file =here::here("analysis","figures","sum_habitat_temp_regression.png"), width = 14, height = 8)
```

```{r}

b_master_out_type %>% 
  left_join(two_month_sst_mean) %>% 
  ggplot(., aes(y=log_sum, x=mean_two_month_sst, colour=Type, fill = Type, group=Type)) +geom_point() +geom_smooth(method="lm") +facet_wrap(.~Type, scales="free") + scale_fill_manual(values=palette.new$color) + scale_colour_manual(values=palette.new$color) +
  stat_poly_eq(formula = y~x, 
                aes(label = paste(..eq.label.., ..rr.label..,..p.value.label.., sep = "~~~")), 
                parse = TRUE,
               label.x = 0.5,
  label.y = 0.1) +
  theme( panel.background = element_rect(fill='white', colour='white'),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          axis.text.x=element_text(size=12, angle=0), 
          axis.text.y=element_text(size=12, angle=0), 
          axis.title.x=element_text(size=16, angle=0,face="bold"), 
          axis.title.y=element_text(size=16, angle=90,face="bold"),
          strip.background = element_rect(fill='grey90'), 
          strip.text.x=element_text(size=14, face='italic'),
          legend.text=element_text(size=10),
          legend.title=element_text(size=15)) + xlab("SST ˚C") + ylab("Mean of Log Abundance Estimates")  -> mean_habitat_temp_regression 

mean_habitat_temp_regression

ggsave(mean_habitat_temp_regression, file =here::here("analysis","figures","mean_habitat_temp_regression.png"), width = 12, height = 12)

```

```{r}

b_master_out_type %>% 
  left_join(two_month_sst) %>% 
  ggplot(., aes(y=sum, x=two_month_sst, colour=Type, fill = Type, group=Type)) +geom_point() +geom_smooth(method="lm") +facet_wrap(.~Type, scales = "free_y") + scale_fill_manual(values=palette.new$color) + scale_colour_manual(values=palette.new$color) +
  stat_poly_eq(formula = y~x, 
                aes(label = paste(..eq.label.., ..rr.label..,..p.value.label.., sep = "~~~")), 
                parse = TRUE,
               label.x = 0.5,
  label.y = 0.1) +
  theme( panel.background = element_rect(fill='white', colour='white'),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          axis.text.x=element_text(size=12, angle=0), 
          axis.text.y=element_text(size=12, angle=0), 
          axis.title.x=element_text(size=16, angle=0,face="bold"), 
          axis.title.y=element_text(size=16, angle=90,face="bold"),
          strip.background = element_rect(fill='grey90'), 
          strip.text.x=element_text(size=14, face='italic'),
          legend.text=element_text(size=10),
          legend.title=element_text(size=15),
         legend.position = "none") + xlab("SST (˚C)") + ylab("Log(Abundance)")  -> sum_habitat_temp_regression_not_log

sum_habitat_temp_regression_not_log

ggsave(sum_habitat_temp_regression_not_log, file =here::here("analysis","figures","sum_habitat_temp_regression_not_log.png"), width = 16, height = 12)

```



#### Supplemental Figure 5

```{r}


b_master_out %>%
  left_join(trait_edna) %>% 
  filter(., Type == "Mesopelagic South") -> b_long_meso_S_edit

b_long_meso_S_edit$Year <- as.numeric(b_long_meso_S_edit$Year)

b_long_meso_S_edit %>% 
  left_join(two_month_sst) %>% 
  ggplot(., aes(y=mean_log, x=two_month_sst, colour=ID_master, fill = ID_master, group=ID_master)) +geom_point() +geom_smooth(method="lm")+facet_wrap(.~ID_master)   + scale_fill_manual(values = c("orangered2","tomato","red3","red4")) + scale_colour_manual(values = c("orangered2","tomato","red3","red4")) +
  stat_poly_eq(formula = y~x, 
                aes(label = paste(..eq.label.., ..rr.label..,..p.value.label.., sep = "~~~")), 
                parse = TRUE,
               label.x = 0.5,
  label.y = 0.1) +
  theme( panel.background = element_rect(fill='white', colour='white'),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          axis.text.x=element_text(size=12, angle=0), 
          axis.text.y=element_text(size=12, angle=0), 
          axis.title.x=element_text(size=16, angle=0,face="bold"), 
          axis.title.y=element_text(size=16, angle=90,face="bold"),
          strip.background = element_rect(fill='grey90'), 
          strip.text.x=element_text(size=14, face='italic'),
          legend.text=element_text(size=10),
          legend.title=element_text(size=15),
         legend.position = "none") + xlab("SST (˚C)") + ylab("Log(Abundance)") +ylim(-4,2) -> habitat_temp_regression_meso_pelagic

habitat_temp_regression_meso_pelagic

ggsave(habitat_temp_regression_meso_pelagic, file =here::here("analysis","figures","habitat_temp_regression_meso_pelagic.png"), width = 16, height = 12)

```



### Figure 1
```{r}

mhw_differential_abundance / (habitat_association_fig_all  + sum_habitat_temp_regression+
  plot_layout(widths = c(3,3))) + 
  plot_annotation(tag_levels = "A")

ggsave(filename = "../analysis/figures/Figure_1_patchwork_mifish.png",
       width=16,
       height = 14,
       dpi = 400,
      units = c("in"))



```

### Figure 2
```{r}
temp_plot_conc +  biomass_conc + garnet_binomial_fig + T_mex_binomial_fig + plot_layout(byrow = F, widths = c(3,2), ncol = 2) + 
    plot_annotation(tag_levels = "A")

ggsave(filename = here("analysis","figures","Figure_2_combo_mifish.png"),
       width=18,
       height = 12,
       dpi = 400,
       units = c("in"))
```
# Supplemental Figure 3 & 4

## All Sites

### Pre processing NMDs and Heatmaps
```{r, functions used, include=FALSE}
#Another version of the dendrogram.  

dendro_data_k <- function(hc, k) {
  
  hcdata    <-  ggdendro::dendro_data(hc, type = "rectangle")
  seg       <-  hcdata$segments
  labclust  <-  cutree(hc, k)[hc$order]
  segclust  <-  rep(0L, nrow(seg))
  heights   <-  sort(hc$height, decreasing = TRUE)
  height    <-  mean(c(heights[k], heights[k - 1L]), na.rm = TRUE)
  
  for (i in 1:k) {
    xi      <-  hcdata$labels$x[labclust == i]
    idx1    <-  seg$x    >= min(xi) & seg$x    <= max(xi)
    idx2    <-  seg$xend >= min(xi) & seg$xend <= max(xi)
    idx3    <-  seg$yend < height
    idx     <-  idx1 & idx2 & idx3
    segclust[idx] <- i
  }
  
  idx                    <-  which(segclust == 0L)
  segclust[idx]          <-  segclust[idx + 1L]
  hcdata$segments$clust  <-  segclust
  hcdata$segments$line   <-  as.integer(segclust < 1L)
  hcdata$labels$clust    <-  labclust
  
  hcdata
}

set_labels_params <- function(nbLabels,
                              direction = c("tb", "bt", "lr", "rl"),
                              fan       = FALSE) {
  if (fan) {
    angle       <-  360 / nbLabels * 1:nbLabels + 90
    idx         <-  angle >= 90 & angle <= 270
    angle[idx]  <-  angle[idx] + 180
    hjust       <-  rep(0, nbLabels)
    hjust[idx]  <-  1
  } else {
    angle       <-  rep(0, nbLabels)
    hjust       <-  0
    if (direction %in% c("tb", "bt")) { angle <- angle + 45 }
    if (direction %in% c("tb", "rl")) { hjust <- 1 }
  }
  list(angle = angle, hjust = hjust, vjust = 0.5)
}

plot_ggdendro <- function(hcdata,
                          direction   = c("lr", "rl", "tb", "bt"),
                          fan         = FALSE,
                          scale.color = NULL,
                          branch.size = 1,
                          label.size  = 3,
                          nudge.label = 0.01,
                          expand.y    = 0.1) {
  
  direction <- match.arg(direction) # if fan = FALSE
  ybreaks   <- pretty(segment(hcdata)$y, n = 5)
  ymax      <- max(segment(hcdata)$y)
  
  ## branches
  p <- ggplot() +
    geom_segment(data         =  segment(hcdata),
                 aes(x        =  x,
                     y        =  y,
                     xend     =  xend,
                     yend     =  yend,
                     linetype =  factor(line),
                     colour   =  factor(clust)),
                 lineend      =  "round",
                 show.legend  =  FALSE,
                 size         =  branch.size)
  
  ## orientation
  if (fan) {
    p <- p +
      coord_polar(direction = -1) +
      scale_x_continuous(breaks = NULL,
                         limits = c(0, nrow(ggdendro::label(hcdata)))) +
      scale_y_reverse(breaks = ybreaks)
  } else {
    p <- p + scale_x_continuous(breaks = NULL)
    if (direction %in% c("rl", "lr")) {
      p <- p + coord_flip()
    }
    if (direction %in% c("bt", "lr")) {
      p <- p + scale_y_reverse(breaks = ybreaks)
    } else {
      p <- p + scale_y_continuous(breaks = ybreaks)
      nudge.label <- -(nudge.label)
    }
  }
  
  # labels
  labelParams <- set_labels_params(nrow(hcdata$labels), direction, fan)
  hcdata$labels$angle <- labelParams$angle
  
  p <- p +
    geom_text(data        =  ggdendro::label(hcdata),
              aes(x       =  x,
                  y       =  y,
                  label   =  label,
                  colour  =  factor(clust),
                  angle   =  angle),
              vjust       =  labelParams$vjust,
              hjust       =  labelParams$hjust,
              nudge_y     =  ymax * nudge.label,
              size        =  label.size,
              show.legend =  FALSE)
  
  # colors and limits
  if (!is.null(scale.color)) {
    p <- p + scale_color_manual(values = scale.color)
  }
  
  ylim <- -round(ymax * expand.y, 1)
  p    <- p + expand_limits(y = ylim)
  
  p
}


```
##### Chronological Clustering

<br />
```{r}
#Format for dend and clustering
b_master_out %>% 
  dplyr::select(Year,  ID_master,Normalized.biomass=  mean) %>% 
  filter(., Normalized.biomass >0) %>% 
  ungroup() %>% 
  group_by(ID_master) %>% 
  dplyr::count() %>% 
  filter(., n> 5) -> species_to_keep

b_master_out %>% 
  dplyr::select(Year,  ID_master,Normalized.biomass=  mean) %>% 
  #filter(., ID_master %in% species_to_keep$ID_master) %>% 
  pivot_wider(names_from=ID_master, values_from=Normalized.biomass) %>% 
  as.data.frame()-> eDNA_long_all_wide

eDNA_long_all_wide$Year -> rownames(eDNA_long_all_wide)
eDNA_long_all_wide[,-1] -> eDNA_long_all_wide

#Create a bray-curtis distance matrix
diss <- vegdist(eDNA_long_all_wide, method='bray')

#Run the chronological cluster; chclust is the main function from rioja
clust <- chclust(diss)


```

```{r}
##Look at the number of clusters.  Then make a category for each cluster
ddata1 <- dendro_data_k(clust,8)

labs <- ggdendro::label(ddata1)
moon4 <- c("black","navy",moon3,"darkred")
p1 <- plot_ggdendro(ddata1,
                    direction   = "tb",
                    label.size  = 2.5,
                    scale.color = moon4,
                    branch.size = 0.5,
                    expand.y    = 0.2)

p1 <- p1 + theme_void() + expand_limits(x = c(-1, 32))
p1

```
```{r, results='hide'}

#Recreate above chronological clustering dendrogram but using same format as species clustering for figure

BPA_9 <- data.frame(eDNA_long_all_wide)

dend2 <- BPA_9 %>% vegdist(., method='bray') %>% chclust() %>% as.dendrogram %>% 
  color_branches(k=6, col = moon3)

```

```{r}
#Color code names of species based on trait information
as.data.frame(moon3) -> mooner
mooner$clust <- seq(1,6)
labs %>% 
  left_join(mooner) -> labs

```
<br />

##### Species Clustering

<br />
```{r,fig.height=8, fig.width=8}
## Input is the distance matrix (abundance, etc), with years on x and species on y. and species names as the rownames.
BPA <- data.frame(t(eDNA_long_all_wide))

colnames(BPA) <- rownames(eDNA_long_all_wide)
#BPA_1 <- BPA %>% vegdist(., method='bray') %>% hclust %>% as.dendrogram 

BPA_1 <- BPA %>% vegdist(., method='bray') %>% hclust %>% as.dendrogram %>% sort(type = "nodes")

#Decide on the number of branches for species, k=3
dend <- BPA %>% vegdist(., method='bray')%>% hclust(method = "complete") %>% as.dendrogram %>% sort(type = "nodes") %>% 
  color_branches(k=5, col=dar3)
plot(dend)
```



```{r}
#Color code names of species based on trait information
as.data.frame(rownames(BPA)) -> species_names

species_names %>% 
  left_join(trait_edna, by=c("rownames(BPA)"="ID_master")) -> species_names

```

##### Heatmap

```{r, fig.height=16, fig.width=8}
#Color palette
some_col_func <- colorspace::sequential_hcl(100,palette="BluYl",power = 200)


BPA2 <- as.matrix(BPA)
BPA2[BPA2 < .01] <- NA



colseperator <- labs %>% 
  group_by(clust) %>% 
  dplyr::summarise(label =max(label)) %>% 
  left_join(labs)

jpeg(file = here("analysis","figures","S3_All_sites_heatmap.png")
     , width=16,
       height = 12,
       res = 400,
      units = c("in"))
gplots::heatmap.2(BPA2, 
                  main = "",
                  srtCol = 60,
                  dendrogram = "both",
                  #density.info="none",
                  Rowv = dend,
                  Colv = dend2, # this to make sure the columns are not ordered
                  trace="none",          
                  #key.xlab = "",
                  #labCol = "",
                  denscol = "lightseagreen",
                  colRow = species_names$species_color,
                  colCol = labs$moon3,
                  margins = c(3,12),
                  density.info = "density",
                  key= TRUE,
                  na.color = "White",
                  colsep= colseperator$x, 
                  sepcolor = "black",
                  col = some_col_func)
dev.off()


gplots::heatmap.2(BPA2, 
                  main = "eDNA All Sites",
                  srtCol = 60,
                  dendrogram = "both",
                  #density.info="none",
                  Rowv = dend,
                  Colv = dend2, # this to make sure the columns are not ordered
                  trace="none",          
                  #key.xlab = "",
                  #labCol = "",
                  denscol = "lightseagreen",
                  colRow = species_names$species_color,
                  colCol = labs$moon3,
                  margins = c(3,12),
                  density.info = "density",
                  key= TRUE,
                  na.color = "White",
                  colsep= colseperator$x, 
                  sepcolor = "black",
                  col = some_col_func)
```


##### NMDS

```{r}

b_master_out %>% 
  dplyr::select(Year,  ID_master,Normalized.biomass=  mean) %>% 
 # filter(., ID_master %in% species_to_keep$ID_master) %>% 
  #mutate(., ID_master = str_replace(ID_master," ",".")) %>% 
  pivot_wider(names_from=ID_master, values_from=Normalized.biomass) %>% 
  as.data.frame()-> eDNA_long_all_wide2


eDNA_long_all_wide2$Year -> rownames(eDNA_long_all_wide2)
eDNA_long_all_wide2[,-1] -> eDNA_long_all_wide2

#NMDS analysis

#Start with the data frame, not the distance matrix

sptran1 <- eDNA_long_all_wide2

mds <- vegan::metaMDS(sptran1,k=2, trace=FALSE, distance = "bray",trymax=100, autotransform = FALSE)
mds ### if stress is under .20, we are okay; if over, may need the change k to 3; 
#stress = .157 at K3
stressplot(mds)

```

```{r}

#Make the nmds plot with ggplot2
###Pull out species info
mdssp <- mds$species
spdf <- data.frame(mdssp)
spdf %>%  drop_na() ->spdf
spdf$species <- rownames(spdf)
#spdf$species1 <- gsub(" ", ".", spdf$species)
spdf1 <- spdf

### This has the habitat and geographic affinities for each species
spdf1 %>% 
  left_join(trait_edna, by=c("species"="ID_master")) -> spdf1
as.factor(spdf1$Type) ->spdf1$Type


#Pull out site info
scor <- scores(mds, display=c("sites","species"))
score1 <- data.frame(eDNA_long_all_wide,scor)
score1$rowname <- rownames(score1)
labs$label -> years

as.data.frame(years) -> nmdscov
rownames(nmdscov) <- nmdscov$years
nmdscov$rowname <- rownames(nmdscov)
score2 <- merge(score1, nmdscov, by="rowname", all.x=T, all.y=F)
score2 <- score2[order(score2$year),] 

### from chron cluster
### assign a cluster to each year
score2$cluster <- as.character(labs$clust)


spdf1 %>% 
  dplyr::select(Type,species_color)%>% distinct() %>% 
  arrange(Type) %>%  dplyr::select(species_color) -> color_order_nmds
  
ggplot()+ 
  geom_vline(xintercept=0,colour="grey50") +
  geom_hline(yintercept=0,colour="grey50") +
  geom_path (data=score2, aes(x = NMDS1, y = NMDS2, alpha=0.2)) +
  geom_text_repel(data=spdf1,  aes(x = MDS1, y = MDS2, label= species, color=Type), size=6, fontface='italic') + 	
  geom_text_repel(data=score2, aes(x = NMDS1, y = NMDS2,label= years, colour=cluster), size=10) + 
  scale_colour_manual(values = c("navy","darkred",moon3,color_order_nmds$species_color)) +
  theme_bw() +
  labs(list(title="", x="NMDS1",y="NMDS2"))  + xlab("NMDS1") +ylab("NMDS2")+
  theme(  panel.background = element_rect(fill='white', colour='white'),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          axis.text.x=element_text(size=14, angle=0), 
          axis.text.y=element_text(size=14, angle=0), 
          axis.title.x=element_text(size=18, angle=0), 
          axis.title.y=element_text(size=18, angle=90),
          strip.background = element_rect(fill='white'), 
          strip.text.x=element_text(size=15),
          legend.text=element_text(size=10),
          legend.title=element_text(size=15),
          axis.line=element_line(colour='black'),
          legend.position="none")	

ggsave(filename = "../analysis/figures/S4_All_sites_NMDS.png",
       width=30,
       height = 30,
       dpi = 400,
      units = c("in"))
```
<br />




