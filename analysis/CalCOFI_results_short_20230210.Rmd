---
title: "CalCOFI_results_20210715"
author: "Zack Gold"
date: "11/15/2021"
output: html_document
---
# Prep Code
## Load Libraries
```{r, hide = TRUE}


library(tidyverse)
library(rstanarm)
options(mc.cores = parallel::detectCores())
library(bayesplot)
library(modelr)
library(tidybayes)
library(heatmaply)
library(wesanderson)
library(dendextend)
library(ggpmisc)
library(here)
library(vegan)
library(ggdendro)
library(rioja)
library(cluster)
library(ggrepel)
library(grid)
library(RColorBrewer)
library(ggallin)
library(patchwork)
library(ggpattern)
library(corrplot)
library(gclus)
library(lattice)

```

## Color Palletes
```{r, Color Palletes ,results='hide'}
# Colors
wes_palette("Darjeeling2") -> dar2
wes_palette("Darjeeling1") -> dar1
wes_palette("FantasticFox1") -> moon1
wes_palette("Royal1") -> br2
wes_palette("Rushmore1") -> br1
wes_palette("IsleofDogs1") -> id1
wes_palette("Royal2") -> id2

dar3 <- c(dar2[2], dar1[2], dar2[4], dar2[3], moon1[5])
#show_col(dar3)

dar4 <- c(id1[1], dar1[2], dar2[2], dar2[3])
#show_col(dar4)
wes_palette("Zissou1") -> moon2
moon3 <- c(id1[1], moon2[1], br2[4], br1[4], br1[3], moon2[5])
#show_col(moon3)

col_27 <-
  c(dar1,
    dar2,
    id1,
    id2,
    moon2[1],
    moon1[5],
    br1[3],
    br2[1],
    moon2[3],
    "darkseagreen",
    "dodgerblue")
col_27[10] <- br2[4]
col_27[13] <- br1[4]

col_23 <- c(dar1, dar2, id1, id2, moon2[1], moon1[5])

palette.new <- read_csv(here("data", "alternative.pallete.csv"))
palette.new %>% 
mutate(
.,
color = case_when(
Type == "Benthic North" ~ "burlywood4",
Type == "Benthic Central"  ~ "burlywood3"  ,
Type == "Benthic Cosmopolitan"  ~
"burlywood1"  ,
Type == "Benthic South"  ~ "darksalmon"  ,
Type == "Mesopelagic North" ~ "#08519c",
Type == "Mesopelagic South"  ~ "#cb181d" ,
Type == "Mesopelagic Cosmopolitan"  ~ "#6baed6" ,
Type == "Mesopelagic Central" ~ "#3182bd" ,
Type == "Coastal Pelagic Central" ~ "#969696",
Type == "Coastal Pelagic North" ~ "black",
Type == "Cosmopolitan"   ~ "grey80"   ,
TRUE ~ "white"
)) -> palette.new
library(scales)
show_col(palette.new$color)

palette.new3 <-
  read_csv(here("data", "alternative.pallete.csv")) %>% filter (!str_detect(Type, "Coastal Pelagic North"))

palette.new3 %>% 
mutate(
.,
color = case_when(
Type == "Benthic North" ~ "burlywood4",
Type == "Benthic Central"  ~ "burlywood3"  ,
Type == "Benthic Cosmopolitan"  ~
"burlywood1"  ,
Type == "Benthic South"  ~ "darksalmon"  ,
Type == "Mesopelagic North" ~ "#08519c",
Type == "Mesopelagic South"  ~ "#cb181d" ,
Type == "Mesopelagic Cosmopolitan"  ~ "#6baed6" ,
Type == "Mesopelagic Central" ~ "#3182bd" ,
Type == "Coastal Pelagic Central" ~ "#969696",
Type == "Coastal Pelagic North" ~ "black",
Type == "Cosmopolitan"   ~ "grey80"   ,
TRUE ~ "white"
)) -> palette.new3

show_col(palette.new3$color)

pallete.fib1b <-
  palette.new %>% filter (!str_detect(Type, "Benthic Cosmopolitan")) %>% filter (!str_detect(Type, "Coastal Pelagic North"))


```


### SST Temp plot
```{r}

metadata2 <-
read.csv(file = "../data/calcofi_metadata_analysis_20210907.csv")

metadata2 %>%
mutate(
.,
station = fct_recode(
Sta_ID,
"80_60" =  "080.0 060.0" ,
"86.7_50" = "086.7 050.0" ,
"93.3_30" = "093.3 030.0",
"93.3_60" = "093.3 060.0"
)
) %>%
group_by(Year, station) %>%
dplyr::summarise(two_month_sst = mean(two_month_sst)) -> two_month_sst

metadata2  %>%
mutate(
.,
station = fct_recode(
Sta_ID,
"Pt. Conception" =  "080.0 060.0" ,
"San Nicholas Island" = "086.7 050.0" ,
"San Diego Inshore" = "093.3 030.0",
"San Diego Offshore" = "093.3 060.0"
)
) %>%
ggplot(., aes(
x = Year,
y = two_month_sst,
group = station,
color = station
)) +
geom_line(size = 1) +
scale_color_manual(values = dar4) +
annotate(
"rect",
xmin = 2014,
xmax = 2019,
ymin = 11.5,
ymax = 19.5,
alpha = .2,
fill = "darkred"
) +
theme_bw() +
theme(
panel.background = element_rect(fill = 'white', colour = 'white'),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text.x = element_text(
size = 12,
angle = 30,
hjust = 1
),
axis.text.y = element_text(size = 12, angle = 0),
axis.title.x = element_text(size = 16,  face = "bold"),
axis.title.y = element_text(size = 16, angle = 90, face = "bold"),
strip.background = element_rect(fill = 'grey90'),
strip.text.x = element_text(size = 15, face = 'italic'),
legend.text = element_text(size = 12),
legend.position = c(0.5, 0.8),
legend.title = element_blank(),
legend.box = "vertical"
) + ylab(" SST ˚C")  -> temp_plot

temp_plot


```


## Trait Data
```{r}

#Trait Data
trait_edna_1 <-
read.csv("../data/habitat_association_to_check_art.csv", header = T)
as.data.frame(trait_edna_1) -> trait_edna

trait_edna %>%
arrange(ID_main) %>% mutate(name = str_replace(ID_main, " ", ".")) %>%  mutate(., ID_main = str_replace(ID_main, "AANOTHER", "sp."))   %>% dplyr::select(-Type) %>%
mutate(Type = str_c(Habitat, " ", Range)) -> trait_edna


trait_edna %>%
mutate(
.,
species_color = case_when(
Type == "Benthic North" ~ "burlywood4",
Type == "Benthic Central"  ~ "burlywood3"  ,
Type == "Benthic Cosmopolitan"  ~
"burlywood1"  ,
Type == "Benthic South"  ~ "darksalmon"  ,
Type == "Mesopelagic North" ~ "#08519c",
Type == "Mesopelagic South"  ~ "#cb181d" ,
Type == "Mesopelagic Cosmopolitan"  ~ "#6baed6" ,
Type == "Mesopelagic Central" ~ "#3182bd" ,
Type == "Coastal Pelagic Central" ~ "#969696",
Type == "Coastal Pelagic North" ~ "black",
Type == "Cosmopolitan"   ~ "grey80"   ,
TRUE ~ "white"
)
) -> trait_edna


```



### STAN Data

Code is commented out where it takes signficant computational power to run analyses. Outputs are saved in a google document for convenience. All code should run when uncommented.

```{r, function for transforming eDNA Index,results='hide'}
#load(here("data","Stan_Fit_combined_20221114_1424.RData"))

```

```{r, Format Stan Data for SST Comparisons, results='hide'}
#### SST Data
# 
#  stanMod <- Output$stanMod
# 
#  pars2 <- rstan::extract(stanMod, par = "b_main_grid")
# 
#  Stations <- Output$Stations
#  Stations %>%
#       separate(station_id, into = c("Year","Rpt_Line","Rpt_Sta"), remove = F, sep="_") %>%
#       unite(., "station" , c("Rpt_Line","Rpt_Sta"), remove=FALSE) -> Stations
# 
#   species_mapping <-  Output$species_mapping %>%  mutate(., ID_main = str_replace(ID_main, "AANOTHER","sp."))
# 
#   rm(Output)
#  rm(stanMod)
# 
# pars2$b_main_grid %>%
#    as_tibble() %>%
#    pivot_longer(., cols = `1.1`:`84.59`, names_to="station.species", values_to = "est") %>%
#    separate(station.species, into = c("station_idx","sp_index_main"), remove = F, sep="\\.") %>%
#    mutate(., station_idx = as.numeric(station_idx),
#           sp_index_main = as.numeric(sp_index_main)) %>%
#     left_join(species_mapping) %>%
#       left_join(Stations) -> b_grid_tibble
# 
# saveRDS(b_grid_tibble, here("data","b_grid_tibble_rpkn.RDS"))

#b_grid_tibble <- readRDS(file = here("data", "b_grid_tibble_rpkn.RDS"))

```

### Year - Species Mean
```{r}
 # b_grid_tibble %>%
 #   mutate(., log_est = log(est + 0.01)) %>%
 #   group_by(Year, ID_main) %>%
 #   dplyr::summarise(
 #   mean = mean(est),
 #   median = median(est),
 #   sd = sd(est),
 #   p05 = quantile(est, probs = 0.05),
 #   p95 = quantile(est, probs = 0.95)
 #   ) %>%
 #   mutate(mean_log = log(mean + 0.1), sd_log = log(sd + 0.1)) -> b_ID_main_out
 # 
 # 
 # saveRDS(b_ID_main_out, here("data","b_ID_main_out.RDS"))

b_ID_main_out <- readRDS(file = here("data", "b_ID_main_out.RDS"))
  

```

### Year - Type Mean
```{r}
 # b_grid_tibble %>%
 #   mutate(., log_est = log(est + 0.01)) %>%
 #   left_join(trait_edna, by = c("ID_main")) %>%
 #   group_by(Year, Type) %>%
 #   dplyr::summarise(
 #   mean = mean(est),
 #   sum = sum(est),
 #   mean_log = mean(log_est),
 #   sd_log = sd(log_est),
 #   p05_log = quantile(log_est, probs = 0.05),
 #   p95_log = quantile(log_est, probs = 0.95)
 #   ) -> b_ID_main_out_type
 # 
 # b_ID_main_out_type %>%
 #   mutate(., log_sum = log(sum + 0.01)) -> b_ID_main_out_type
 # 
 # 
 # saveRDS(b_ID_main_out_type, here("data","b_ID_main_out_type.RDS"))

b_ID_main_out_type <- readRDS(file = here("data", "b_ID_main_out_type.RDS"))

```

### Year - Site - Species
```{r, results='hide'}

 # 
 # b_grid_tibble %>%
 # mutate(., log_est = log10(est + 0.01)) %>%
 # group_by(Year, station, ID_main) %>%
 # dplyr::summarise(
 # mean = mean(est),
 # median = median(est),
 # sd = sd(est),
 # p05 = quantile(est, probs = 0.05),
 # p95 = quantile(est, probs = 0.95)
 # ) %>%
 # mutate(mean_log = log10(mean + 0.01), sd_log = log10(sd + 0.01)) -> b_ID_main_out_site
 # 
 # b_ID_main_out_site$Year  <- as.numeric(b_ID_main_out_site$Year)
 # 
 # saveRDS(b_ID_main_out_site, here("data","b_ID_main_out_site.RDS"))

b_ID_main_out_site <- readRDS(file = here("data", "b_ID_main_out_site.RDS"))

#Format Data
#  test_nest_a <- b_ID_main_out_site %>%
#  mutate(.,
#  Normalized.biomass = mean,
#  log_Normalized.biomass = mean_log) %>%
#  left_join(two_month_sst) %>%
#  mutate(PA_biomass = if_else(Normalized.biomass > 0.01, 1, 0)) %>%
#  ungroup() %>%
#  mutate(temp_std = (two_month_sst - mean(two_month_sst)) / sd(two_month_sst)) %>%
#  mutate(., ID_main = str_replace(ID_main, "AANOTHER", "sp.")) %>%
#  group_by(ID_main) %>%
#  nest
#  
# saveRDS(test_nest_a, here("data","test_nest_a.RDS"))

test_nest_a <- readRDS(file = here("data", "test_nest_a.RDS"))

```

### MHW Comparison - Species
```{r, Format Stan Data for MHW Comparisons, results='hide'}


##### MHW Data
#  
#  pars2$b_main_grid  %>%
#  as_tibble() %>% mutate(id = row_number()) %>%
#  pivot_longer(.,
#  cols = `1.1`:`84.59`,
#  names_to = "station.species",
#  values_to = "est") %>%
#  separate(
#  station.species,
#  into = c("station_idx", "sp_index_main"),
#  remove = F,
#  sep = "\\."
#  ) %>%
#  mutate(
#  .,
#  station_idx = as.numeric(station_idx),
#  sp_index_main = as.numeric(sp_index_main)
#  ) %>%
#  left_join(species_mapping) %>%
#  left_join(Stations) -> b_grid_tibble_2
#  
# saveRDS(b_grid_tibble_2, here("data", "b_grid_tibble_2_rpkn.RDS"))

#b_grid_tibble_2 <-readRDS(file = here("data", "b_grid_tibble_2_rpkn.RDS"))
# 
#  b_grid_tibble_2 %>%
#  mutate(
#  .,
#  MHW = case_when(
#  Year == "2014" ~ "MHW",
#  Year == "2015" ~ "MHW",
#  Year == "2016" ~ "MHW",
#  Year == "2017" ~ "MHW",
#  Year == "2018" ~ "MHW",
#  Year == "2019" ~ "MHW",
#  TRUE ~ "Before"
#  )
#  ) %>%
#  mutate(., log_est = log(est + 0.01)) %>%
#  group_by(ID_main, MHW, id) %>%
#  dplyr::summarise(mean_b_est_log = mean(log_est),
#  mean_b_est = mean(est)) -> b_ID_main_dist_out
#  
#  b_ID_main_dist_out %>% pivot_wider(
#  values_from = c(mean_b_est_log, mean_b_est),
#  names_glue = "{MHW}_{.value}",
#  names_from = MHW
#  ) %>%
#  mutate(., `MHW-Before` = MHW_mean_b_est - Before_mean_b_est) -> b_ID_main_dist_out
#  
#  
#  saveRDS(b_ID_main_dist_out, here("data","b_ID_main_dist_out.RDS"))

b_ID_main_dist_out <- readRDS(file = here("data", "b_ID_main_dist_out.RDS"))

```

### MHW - Site
```{r}
 # b_grid_tibble_2 %>%
 #   mutate(
 #   .,
 #   MHW = case_when(
 #   Year == "2014" ~ "MHW",
 #   Year == "2015" ~ "MHW",
 #   Year == "2016" ~ "MHW",
 #   Year == "2017" ~ "MHW",
 #   Year == "2018" ~ "MHW",
 #   Year == "2019" ~ "MHW",
 #   TRUE ~ "Before"
 #   )
 #   ) %>%
 #   mutate(., log_est = log(est + 0.01)) %>%
 #   group_by(ID_main, MHW, id, station) %>%
 #   dplyr::summarise(mean_b_est = mean(log_est)) -> b_ID_main_dist_out_station
 #   
 # b_ID_main_dist_out_station %>% 
 #     pivot_wider(values_from = mean_b_est, names_from =
 #   MHW) %>%
 #   mutate(., `MHW-Before` = MHW - Before) -> b_ID_main_dist_out_station
 #   
 # saveRDS(b_ID_main_dist_out_station, here("data","b_ID_main_dist_out_station.RDS"))

b_ID_main_dist_out_station <- readRDS(file = here("data", "b_ID_main_dist_out_station.RDS"))
```

# MHW Comparisons

### Averaged Across Sites

```{r}
b_ID_main_dist_out  -> b_MHW

b_MHW %>% 
  group_by(ID_main) %>% 
  dplyr::summarise(mean=mean(`MHW-Before`), median=median(`MHW-Before`),sd=sd(`MHW-Before`), p05= quantile(`MHW-Before`, probs=0.05), p95= quantile(`MHW-Before`, probs=0.95)) -> MHW_species_summary
  
MHW_species_summary %>% 
  mutate(., Sig_MHW = case_when(p05 > 0 & mean > 0 & p95 > 0 ~"+",
                                p05 < 0 & mean < 0 & p95 < 0 ~"-",
                                TRUE ~"")) %>% 
  filter(., Sig_MHW != "")-> MHW_species_summary_sig

MHW_species_summary_sig %>% 
     left_join(trait_edna, by=c("ID_main")) %>% 
  arrange(desc(mean)) %>%  dplyr::select(species_color) -> MHW_species_summary_sig_colors


MHW_species_summary_sig %>%
  left_join(trait_edna) -> MHW_species_summary_sig

MHW_species_summary_sig %>% 
  dplyr::select(Type, species_color) %>%  unique()-> species_color_mhw


species_color_mhw$Type <- as.character(species_color_mhw$Type)
species_color_mhw$Type <- factor(species_color_mhw$Type, levels=c("Benthic North" ,"Benthic Central","Benthic Cosmopolitan","Benthic South", "Coastal Pelagic North", "Coastal Pelagic Central","Mesopelagic North","Mesopelagic Central" , "Mesopelagic Cosmopolitan"  ,"Mesopelagic South"))

species_color_mhw %>% arrange(Type) -> species_color_mhw

MHW_species_summary_sig$Type <- as.character(MHW_species_summary_sig$Type)
MHW_species_summary_sig$Type <- factor(MHW_species_summary_sig$Type, levels=c("Benthic North" ,"Benthic Central","Benthic Cosmopolitan","Benthic South", "Coastal Pelagic North", "Coastal Pelagic Central","Mesopelagic North","Mesopelagic Central" , "Mesopelagic Cosmopolitan"  ,"Mesopelagic South"))




MHW_species_summary_sig %>% 
          mutate(., ID_main=recode(ID_main,`Sebastes`="Sebastes sp.",
                               `Stenobrachius nannochir`="Stenobrachius leucopsarus cold variant")) %>% 
  ggplot(., aes(y= mean, x= reorder(ID_main, -mean), fill=Type)) +  geom_bar(position="stack", stat="identity") +
  scale_fill_manual( values = species_color_mhw$species_color) + ylab(expression(Delta*"Abundance")) + guides(fill=guide_legend(title="Habitat Association")) + scale_y_continuous(trans = pseudolog10_trans, breaks = c(-40, 0,40,80,400 )) +
  theme(axis.text.x = element_text(size=12,angle= 45, hjust= 1), 
        panel.background = element_rect(fill='white', colour='white'),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          axis.text.y=element_text(size=16, angle=0), 
          axis.title.x=element_blank(), 
          axis.title.y=element_text(size=20, angle=90,face="bold"),
          strip.background = element_rect(fill='white'), 
          strip.text.x=element_text(size=15),
          legend.text=element_text(size=16),
          legend.title=element_text(size=18),
          axis.line=element_line(colour='black'), 
        legend.position = c(0.9, 0.7) )   -> mhw_differential_abundance
mhw_differential_abundance

ggsave(mhw_differential_abundance, file =here::here("analysis","figures","mhw_differential_abundance.png"), width = 12, height = 8)

```

### All Sites Individually
```{r}

b_ID_main_dist_out_station %>% 
  group_by(ID_main, station) %>% 
  dplyr::summarise(mean=mean(`MHW-Before`), median=median(`MHW-Before`),sd=sd(`MHW-Before`), p05= quantile(`MHW-Before`, probs=0.05), p95= quantile(`MHW-Before`, probs=0.95))  %>% mutate(.,
station = fct_recode(station,
"1. Pt. Conception" =  "80_60" ,
"2. San Nicholas Island" = "86.7_50" ,
"3. San Diego Inshore" = "93.3_30",
"4. San Diego Offshore" = "93.3_60")
) -> MHW_species_summary_site
  
MHW_species_summary_site %>% 
  mutate(., Sig_MHW = case_when(p05 > 0 & mean > 0 & p95 > 0 ~"+",
                                p05 < 0 & mean < 0 & p95 < 0 ~"-",
                                TRUE ~"")) -> MHW_species_summary_sig_site_all


MHW_species_summary_sig_site_all %>% 
     left_join(trait_edna, by=c("ID_main")) %>% 
  arrange(desc(mean)) %>%  dplyr::select(species_color) -> MHW_species_summary_sig_colors_all


MHW_species_summary_sig_site_all %>%
  left_join(trait_edna) -> MHW_species_summary_sig_all

MHW_species_summary_sig_all %>% 
  dplyr::select(Type, species_color) %>%  unique()-> species_color_mhw_all


species_color_mhw_all$Type <- as.character(species_color_mhw_all$Type)
species_color_mhw_all$Type <- factor(species_color_mhw_all$Type, levels=c("Benthic North" ,"Benthic Central","Benthic Cosmopolitan","Benthic South", "Coastal Pelagic North", "Coastal Pelagic Central","Mesopelagic North","Mesopelagic Central" , "Mesopelagic Cosmopolitan"  ,"Mesopelagic South"))

species_color_mhw_all %>% arrange(Type) -> species_color_mhw_all

MHW_species_summary_sig_all$Type <- as.character(MHW_species_summary_sig_all$Type)

MHW_species_summary_sig_all$Type <- factor(MHW_species_summary_sig_all$Type, levels=c("Benthic North" ,"Benthic Central","Benthic Cosmopolitan","Benthic South", "Coastal Pelagic North", "Coastal Pelagic Central","Mesopelagic North","Mesopelagic Central" , "Mesopelagic Cosmopolitan"  ,"Mesopelagic South"))

MHW_species_summary_sig_all$Type %>% unique() -> all_type

palette.new %>% 
 filter(., Type %in% all_type) -> palette.new8

palette.new8$Type <- factor(palette.new8$Type, levels=c("Benthic North" ,"Benthic Central","Benthic Cosmopolitan","Benthic South", "Coastal Pelagic North", "Coastal Pelagic Central","Mesopelagic North","Mesopelagic Central" , "Mesopelagic Cosmopolitan"  ,"Mesopelagic South"))

palette.new8 %>% arrange(Type) -> palette.new8


MHW_species_summary_sig_all %>% 
          mutate(., ID_main=recode(ID_main,`Sebastes`="Sebastes sp.",
                               `Stenobrachius nannochir`="Stenobrachius leucopsarus cold variant"))%>% 
  ggplot(., aes(y= mean, x= reorder(ID_main, -mean), fill=Type)) +  geom_bar(position="stack", stat="identity") +
  scale_fill_manual( values = palette.new8$color) + ylab(expression(Delta*"Abundance")) + guides(fill=guide_legend(title="Habitat Association"))  +geom_text(aes(label=Sig_MHW, y = mean + 0.3 * sign(mean)),size=8)+
  theme(axis.text.x = element_text(size=14,angle= 75, hjust= 1), 
        panel.background = element_rect(fill='white', colour='white'),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          axis.text.y=element_text(size=20, angle=0), 
          axis.title.x=element_blank(), 
          axis.title.y=element_text(size=24, angle=90,face="bold"),
          strip.background = element_rect(fill='white'), 
          strip.text.y=element_text(size=18,face="bold"),
          legend.text=element_text(size=14),
          legend.title=element_text(size=18,face="bold"),
          axis.line=element_line(colour='black'),
        panel.spacing = unit(2, "lines"))  + facet_grid(station~ .)   -> mhw_differential_abundance_all
mhw_differential_abundance_all

```

### SD Offshore

```{r}

MHW_species_summary_sig_site_all %>% 
  filter(., station =="San Diego Offshore") -> sig_sd_off_mhw


sig_sd_off_mhw %>% 
     left_join(trait_edna, by=c("ID_main")) %>% 
  arrange(desc(mean)) %>%  dplyr::select(species_color) -> MHW_species_summary_sig_colors_south


sig_sd_off_mhw %>%
  left_join(trait_edna) -> MHW_species_summary_sig_south

MHW_species_summary_sig_south %>% 
  dplyr::select(Type, species_color) %>%  unique()-> species_color_mhw_south


species_color_mhw_south$Type <- as.character(species_color_mhw_south$Type)
species_color_mhw_south$Type <- factor(species_color_mhw_south$Type, levels=c("Benthic North" ,"Benthic Central","Benthic Cosmopolitan","Benthic South", "Coastal Pelagic North", "Coastal Pelagic Central","Mesopelagic North","Mesopelagic Central" , "Mesopelagic Cosmopolitan"  ,"Mesopelagic South"))

species_color_mhw_south %>% arrange(Type) -> species_color_mhw_south

MHW_species_summary_sig_south$Type <- as.character(MHW_species_summary_sig_south$Type)

MHW_species_summary_sig_south$Type <- factor(MHW_species_summary_sig_south$Type, levels=c("Benthic North" ,"Benthic Central","Benthic Cosmopolitan","Benthic South", "Coastal Pelagic North", "Coastal Pelagic Central","Mesopelagic North","Mesopelagic Central" , "Mesopelagic Cosmopolitan"  ,"Mesopelagic South"))

MHW_species_summary_sig_south$Type %>% unique() -> south_type

palette.new %>% 
 filter(., Type %in% south_type) -> palette.new4

MHW_species_summary_sig_south %>% 
          mutate(., ID_main=recode(ID_main,`Sebastes`="Sebastes sp.",
                               `Stenobrachius nannochir`="Stenobrachius leucopsarus cold variant"))%>% 
  ggplot(., aes(y= mean, x= reorder(ID_main, -mean), fill=Type)) +  geom_bar(position="stack", stat="identity") +
  scale_fill_manual( values = palette.new4$color) + ylab(expression(Delta*"Abundance")) + guides(fill=guide_legend(title="Habitat Association"))  +
  theme(axis.text.x = element_text(size=12,angle= 45, hjust= 1), 
        panel.background = element_rect(fill='white', colour='white'),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          axis.text.y=element_text(size=16, angle=0), 
          axis.title.x=element_blank(), 
          axis.title.y=element_text(size=20, angle=90,face="bold"),
          strip.background = element_rect(fill='white'), 
          strip.text.x=element_text(size=15),
          legend.text=element_text(size=10),
          legend.title=element_text(size=12),
          axis.line=element_line(colour='black'), 
        legend.position = c(.9, 0.85) )  +ylim(-6,4) -> mhw_differential_abundance_south
mhw_differential_abundance_south

ggsave(mhw_differential_abundance_south, file =here::here("analysis","figures","mhw_differential_abundance_sd_off.png"), width = 12, height = 8)


```
### SD Inshore

```{r}

MHW_species_summary_sig_site_all %>% 
  filter(., station =="San Diego Inshore") -> sig_sd_in_mhw

sig_sd_in_mhw %>% 
     left_join(trait_edna, by=c("ID_main")) %>% 
  arrange(desc(mean)) %>%  dplyr::select(species_color) -> MHW_species_summary_sig_colors_south


sig_sd_in_mhw %>%
  left_join(trait_edna) -> MHW_species_summary_sig_south

MHW_species_summary_sig_south %>% 
  dplyr::select(Type, species_color) %>%  unique()-> species_color_mhw_south


species_color_mhw_south$Type <- as.character(species_color_mhw_south$Type)
species_color_mhw_south$Type <- factor(species_color_mhw_south$Type, levels=c("Benthic North" ,"Benthic Central","Benthic Cosmopolitan","Benthic South", "Coastal Pelagic North", "Coastal Pelagic Central","Mesopelagic North","Mesopelagic Central" , "Mesopelagic Cosmopolitan"  ,"Mesopelagic South"))

species_color_mhw_south %>% arrange(Type) -> species_color_mhw_south

MHW_species_summary_sig_south$Type <- as.character(MHW_species_summary_sig_south$Type)

MHW_species_summary_sig_south$Type <- factor(MHW_species_summary_sig_south$Type, levels=c("Benthic North" ,"Benthic Central","Benthic Cosmopolitan","Benthic South", "Coastal Pelagic North", "Coastal Pelagic Central","Mesopelagic North","Mesopelagic Central" , "Mesopelagic Cosmopolitan"  ,"Mesopelagic South"))

MHW_species_summary_sig_south$Type %>% unique() -> south_type

palette.new %>% 
 filter(., Type %in% south_type) -> palette.new4


palette.new4$Type <- factor(palette.new4$Type, levels=c("Benthic North" ,"Benthic Central","Benthic Cosmopolitan","Benthic South", "Coastal Pelagic North", "Coastal Pelagic Central","Mesopelagic North","Mesopelagic Central" , "Mesopelagic Cosmopolitan"  ,"Mesopelagic South"))

palette.new4 %>% arrange(Type)  ->palette.new4


MHW_species_summary_sig_south %>% 
          mutate(., ID_main=recode(ID_main,`Sebastes`="Sebastes sp.",
                               `Stenobrachius nannochir`="Stenobrachius leucopsarus cold variant"))%>% 
  ggplot(., aes(y= mean, x= reorder(ID_main, -mean), fill=Type)) +  geom_bar(position="stack", stat="identity") +
  scale_fill_manual( values = palette.new4$color) + ylab(expression(Delta*"Abundance")) + guides(fill=guide_legend(title="Habitat Association"))  +
  theme(axis.text.x = element_text(size=12,angle= 45, hjust= 1), 
        panel.background = element_rect(fill='white', colour='white'),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          axis.text.y=element_text(size=16, angle=0), 
          axis.title.x=element_blank(), 
          axis.title.y=element_text(size=20, angle=90,face="bold"),
          strip.background = element_rect(fill='white'), 
          strip.text.x=element_text(size=15),
          legend.text=element_text(size=10),
          legend.title=element_text(size=12),
          axis.line=element_line(colour='black'), 
        legend.position = c(.9, 0.85) )  +ylim(-6,4) -> mhw_differential_abundance_south
mhw_differential_abundance_south

ggsave(mhw_differential_abundance_south, file =here::here("analysis","figures","mhw_differential_abundance_sd_off.png"), width = 12, height = 8)



```

### Legend of Species w/ Colors
```{r}
library(ggpubr)

MHW_species_summary_sig_south %>% 
          mutate(., ID_main=recode(ID_main,`Sebastes`="Sebastes sp.",
                               `Stenobrachius nannochir`="Stenobrachius leucopsarus cold variant"))%>% 
  ggplot(., aes(y= mean, x= reorder(ID_main, -mean), fill=Type)) +  geom_bar(position="stack", stat="identity") +
  scale_fill_manual( values = palette.new4$color) + ylab(expression(Delta*"Abundance")) + guides(fill=guide_legend(title="Species Habitat Association"))  +
  theme(axis.text.x = element_text(size=12,angle= 45, hjust= 1), 
        panel.background = element_rect(fill='white', colour='white'),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          axis.text.y=element_text(size=16, angle=0), 
          axis.title.x=element_blank(), 
          axis.title.y=element_text(size=20, angle=90,face="bold"),
          strip.background = element_rect(fill='white'), 
          strip.text.x=element_text(size=15),
          legend.text=element_text(size=10),
          legend.title=element_text(size=12),
          axis.line=element_line(colour='black'), 
        legend.position = c(.5, 0.5) )  +ylim(-6,4) -> legend_holder
leg <- get_legend(legend_holder) 
leg 
# Convert to a ggplot and print
as_ggplot(leg) + plot_layout(tag_level = 'new') -> leggers 
as_ggplot(leg)  -> leggest

```

### SD Inshore

```{r}
MHW_species_summary_sig_site_all %>% 
  filter(., station =="San Diego Inshore") -> sig_sd_in_mhw

sig_sd_in_mhw %>% 
     left_join(trait_edna, by=c("ID_main")) %>% 
  arrange(desc(mean)) %>%  dplyr::select(species_color) -> MHW_species_summary_sig_colors_sd_in


sig_sd_in_mhw %>%
  left_join(trait_edna) -> MHW_species_summary_sig_sd_in

MHW_species_summary_sig_sd_in %>% 
  dplyr::select(Type, species_color) %>%  unique()-> species_color_mhw_sd_in


MHW_species_summary_sig_sd_in$Type <- as.character(MHW_species_summary_sig_sd_in$Type)
MHW_species_summary_sig_sd_in$Type <- factor(MHW_species_summary_sig_sd_in$Type, levels=c("Benthic North" ,"Benthic Central","Benthic Cosmopolitan","Benthic South", "Coastal Pelagic North", "Coastal Pelagic Central","Mesopelagic North","Mesopelagic Central" , "Mesopelagic Cosmopolitan"  ,"Mesopelagic South"))

MHW_species_summary_sig_sd_in %>% arrange(Type) -> MHW_species_summary_sig_sd_in

MHW_species_summary_sig_sd_in$Type <- as.character(MHW_species_summary_sig_sd_in$Type)

MHW_species_summary_sig_sd_in$Type <- factor(MHW_species_summary_sig_sd_in$Type, levels=c("Benthic North" ,"Benthic Central","Benthic Cosmopolitan","Benthic South", "Coastal Pelagic North", "Coastal Pelagic Central","Mesopelagic North","Mesopelagic Central" , "Mesopelagic Cosmopolitan"  ,"Mesopelagic South"))

MHW_species_summary_sig_sd_in$Type %>% unique() -> south_type

palette.new %>% 
 filter(., Type %in% south_type) -> palette.new4

MHW_species_summary_sig_sd_in %>% 
          mutate(., ID_main=recode(ID_main,`Sebastes`="Sebastes sp.",
                               `Stenobrachius nannochir`="Stenobrachius leucopsarus cold variant")) %>% 
  ggplot(., aes(y= mean, x= reorder(ID_main, -mean), fill=Type)) +  geom_bar(position="stack", stat="identity") +
  scale_fill_manual( values = palette.new4$color) + ylab(expression(Delta*"Abundance")) + guides(fill=guide_legend(title="Habitat Association"))  +
  theme(axis.text.x = element_text(size=8,angle= 45, hjust= 1), 
        panel.background = element_rect(fill='white', colour='white'),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          axis.text.y=element_text(size=16, angle=0), 
          axis.title.x=element_blank(), 
          axis.title.y=element_text(size=20, angle=90,face="bold"),
          strip.background = element_rect(fill='white'), 
          strip.text.x=element_text(size=15),
          legend.text=element_text(size=16),
          legend.title=element_text(size=18),
          axis.line=element_line(colour='black'), 
        legend.position = c(.9, 0.8) )   -> mhw_differential_abundance_sd_in
mhw_differential_abundance_sd_in


```


### Pt. Conception

```{r}
MHW_species_summary_sig_site_all %>% 
  filter(., station =="Pt. Conception") -> sig_pc_mhw

sig_pc_mhw %>% 
     left_join(trait_edna, by=c("ID_main")) %>% 
  arrange(desc(mean)) %>%  dplyr::select(species_color) -> MHW_species_summary_sig_colors_pc


sig_pc_mhw %>%
  left_join(trait_edna) -> MHW_species_summary_sig_pc

MHW_species_summary_sig_pc %>% 
  dplyr::select(Type, species_color) %>%  unique()-> species_color_mhw_pc


MHW_species_summary_sig_pc$Type <- as.character(MHW_species_summary_sig_pc$Type)
MHW_species_summary_sig_pc$Type <- factor(MHW_species_summary_sig_pc$Type, levels=c("Benthic North" ,"Benthic Central","Benthic Cosmopolitan","Benthic South", "Coastal Pelagic North", "Coastal Pelagic Central","Mesopelagic North","Mesopelagic Central" , "Mesopelagic Cosmopolitan"  ,"Mesopelagic South"))

MHW_species_summary_sig_pc %>% arrange(Type) -> MHW_species_summary_sig_pc

MHW_species_summary_sig_pc$Type <- as.character(MHW_species_summary_sig_pc$Type)

MHW_species_summary_sig_pc$Type <- factor(MHW_species_summary_sig_pc$Type, levels=c("Benthic North" ,"Benthic Central","Benthic Cosmopolitan","Benthic South", "Coastal Pelagic North", "Coastal Pelagic Central","Mesopelagic North","Mesopelagic Central" , "Mesopelagic Cosmopolitan"  ,"Mesopelagic South"))

MHW_species_summary_sig_pc$Type %>% unique() -> south_type

palette.new %>% 
 filter(., Type %in% south_type) -> palette.new4

MHW_species_summary_sig_pc %>% 
          mutate(., ID_main=recode(ID_main,`Sebastes`="Sebastes sp.",
                               `Stenobrachius nannochir`="Stenobrachius leucopsarus cold variant")) %>% 
  ggplot(., aes(y= mean, x= reorder(ID_main, -mean), fill=Type)) +  geom_bar(position="stack", stat="identity") +
  scale_fill_manual( values = palette.new4$color) + ylab(expression(Delta*"Abundance")) + guides(fill=guide_legend(title="Habitat Association"))  +
  theme(axis.text.x = element_text(size=8,angle= 45, hjust= 1), 
        panel.background = element_rect(fill='white', colour='white'),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          axis.text.y=element_text(size=16, angle=0), 
          axis.title.x=element_blank(), 
          axis.title.y=element_text(size=20, angle=90,face="bold"),
          strip.background = element_rect(fill='white'), 
          strip.text.x=element_text(size=15),
          legend.text=element_text(size=12),
          legend.title=element_text(size=14),
          axis.line=element_line(colour='black'), 
        legend.position = c(.9, 0.8) ) +ylim(-6,4)  -> mhw_differential_abundance_pc
mhw_differential_abundance_pc


```

### San Nicholas Island

```{r}
MHW_species_summary_sig_site_all %>% 
  filter(., station =="San Nicholas Island") -> sig_sni_mhw

sig_sni_mhw %>% 
     left_join(trait_edna, by=c("ID_main")) %>% 
  arrange(desc(mean)) %>%  dplyr::select(species_color) -> MHW_species_summary_sig_colors_sni


sig_sni_mhw %>%
  left_join(trait_edna) -> MHW_species_summary_sig_sni

MHW_species_summary_sig_sni %>% 
  dplyr::select(Type, species_color) %>%  unique()-> species_color_mhw_sni


MHW_species_summary_sig_sni$Type <- as.character(MHW_species_summary_sig_sni$Type)
MHW_species_summary_sig_sni$Type <- factor(MHW_species_summary_sig_sni$Type, levels=c("Benthic North" ,"Benthic Central","Benthic Cosmopolitan","Benthic South", "Coastal Pelagic North", "Coastal Pelagic Central","Mesopelagic North","Mesopelagic Central" , "Mesopelagic Cosmopolitan"  ,"Mesopelagic South"))

MHW_species_summary_sig_sni %>% arrange(Type) -> MHW_species_summary_sig_sni

MHW_species_summary_sig_sni$Type <- as.character(MHW_species_summary_sig_sni$Type)

MHW_species_summary_sig_sni$Type <- factor(MHW_species_summary_sig_sni$Type, levels=c("Benthic North" ,"Benthic Central","Benthic Cosmopolitan","Benthic South", "Coastal Pelagic North", "Coastal Pelagic Central","Mesopelagic North","Mesopelagic Central" , "Mesopelagic Cosmopolitan"  ,"Mesopelagic South"))

MHW_species_summary_sig_sni$Type %>% unique() -> south_type

palette.new %>% 
 filter(., Type %in% south_type) -> palette.new4

MHW_species_summary_sig_sni %>% 
         mutate(., ID_main=recode(ID_main,`Sebastes`="Sebastes sp.",
                               `Stenobrachius nannochir`="Stenobrachius leucopsarus cold variant")) %>% 
  ggplot(., aes(y= mean, x= reorder(ID_main, -mean), fill=Type)) +  geom_bar(position="stack", stat="identity") +
  scale_fill_manual( values = palette.new4$color) + ylab(expression(Delta*"Abundance")) + guides(fill=guide_legend(title="Habitat Association"))  +
  theme(axis.text.x = element_text(size=8,angle= 45, hjust= 1), 
        panel.background = element_rect(fill='white', colour='white'),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          axis.text.y=element_text(size=16, angle=0), 
          axis.title.x=element_blank(), 
          axis.title.y=element_text(size=20, angle=90,face="bold"),
          strip.background = element_rect(fill='white'), 
          strip.text.x=element_text(size=15),
          legend.text=element_text(size=16),
          legend.title=element_text(size=18),
          axis.line=element_line(colour='black'), 
        legend.position = c(.9, 0.8) )   -> mhw_differential_abundance_sni
mhw_differential_abundance_sni


```




# Figure 4 MHW
```{r}

mhw_differential_abundance_all 

ggsave(filename = here("analysis","figures","Figure_4_MHW_dif_all.png"),
       width=14,
       height = 16,
       dpi = 400,
      units = c("in"))


```

# Focal Species
## Anchovy and Sardine


## Anchovy and Sardine -Site
```{r}
b_ID_main_out_site %>% 
 subset(., ID_main %in% c("Engraulis mordax","Sardinops sagax")) %>% 
  mutate(.,Species= fct_recode(ID_main,
   "Northern Anchovy"= "Engraulis mordax" , "Pacific Sardine"= "Sardinops sagax" ), Year=as.numeric(Year)) %>% 
  mutate(., station= fct_recode(station,
   "1. Pt. Conception"=  "80_60" , "2. San Nicholas Island"= "86.7_50" , "3. San Diego Inshore"="93.3_30", "4. San Diego Offshore"= "93.3_60")) -> b_long_all_edit

b_long_all_edit %>% 
  mutate(., median_log = log(median+0.1),sd_log = log(sd+0.1),p05_log = log(p05+0.1),p95_log = log(p95+0.1) ) -> b_long_all_edit_site

ggplot(data=b_long_all_edit_site, aes(x=Year, group=Species, color=Species)) + 
  scale_color_manual(values=c("navy","darkred")) +
  geom_point(aes(y=`median_log`),size=2, na.rm = TRUE) +
  geom_line(aes(y=`median_log`),size=0.5, na.rm = TRUE) +
  geom_errorbar(aes(ymin = p05_log, ymax = p95_log), width = 0.1) +
  facet_wrap(station~., ncol=1) +theme_bw() +		## makes background white
  theme(  panel.background = element_rect(fill='white', colour='white'),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          axis.text.x=element_text(size=10, angle=20, hjust = 0.65), 
          axis.text.y=element_text(size=12, angle=0), 
          axis.title.x=element_text(size=16, angle=0,face="bold"), 
          axis.title.y=element_text(size=16, angle=90,face="bold"),
          strip.background = element_rect(fill='grey90'), 
          strip.text.x=element_text(size=14, face='italic'),
          legend.text=element_text(size=12),
          legend.title = element_blank(),
         legend.box = "vertical") + ylab("log(Abundance)")+ annotate("rect", xmin = 2014, xmax = 2019, ymin = -3, ymax = 10, alpha = .2,fill = "darkred")-> biomass_site_chovy_sard
biomass_site_chovy_sard


```


```{r}

metadata2  %>%
mutate(
.,
station = fct_recode(
Sta_ID,
"1. Pt. Conception" =  "080.0 060.0" ,
"2. San Nicholas Island" = "086.7 050.0" ,
"3. San Diego Inshore" = "093.3 030.0",
"4. San Diego Offshore" = "093.3 060.0"
)
) -> temp_holder

temp_holder %>% 
filter(., station == "1. Pt. Conception") -> conc_temp
temp_holder %>% 
filter(., station == "2. San Nicholas Island") -> sni_temp
temp_holder %>% 
filter(., station == "3. San Diego Inshore") -> sdi_temp
temp_holder %>% 
filter(., station == "4. San Diego Offshore") -> sdo_temp

```
## Anchovy Sardine Pt. Conception

```{r}
b_long_all_edit_site %>% 
  filter(., station ==  "1. Pt. Conception") -> b_long_all_edit_site_conception

coeff1 <- 2.4
coeff2 <- -24

biomass_conc <- ggplot(data=b_long_all_edit_site_conception, aes(x=Year)) + 
    geom_rect_pattern(
    aes(
      xmin=2014, ymin=-3, xmax=2019, ymax=20,
      pattern_angle   = I(45),
      pattern_colour  = I("grey90"),
      pattern_spacing = I(0.05),
      pattern_size    = I(0.25)
    ),
    pattern         = 'stripe',
    fill            = 'white',
    colour          = 'white',
    pattern_density = 0.3
  ) +
  scale_color_manual(values=c("navy","darkred")) +
  geom_point(aes(y=`median_log`, group=Species, color=Species),size=2, na.rm = TRUE) +
  geom_line(aes(y=`median_log`,group=Species, color=Species),size=1, na.rm = TRUE) +
  geom_errorbar(aes(ymin = p05_log, ymax = p95_log,group=Species, color=Species), width = 0.1)  +
geom_line(data=conc_temp, aes(x=Year, y=(coeff2+two_month_sst*coeff1)), size = 2, color= "black") +
scale_y_continuous(
    
    # Features of the first axis
    name = "log(Abundance)",
    
    # Add a second axis and specify its features
    sec.axis = sec_axis(~(.-coeff2)/coeff1, name="SST ˚C")
  ) +
  theme_bw() +		## makes background white
  theme(  panel.background = element_rect(fill='white', colour='white'),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          axis.text.x=element_text(size=10, angle=20, hjust = 0.65), 
          axis.text.y=element_text(size=12, angle=0), 
          axis.title.x=element_text(size=16, angle=0,face="bold"), 
          axis.title.y=element_text(size=16, angle=90,face="bold"),
          strip.background = element_rect(fill='grey90'), 
          strip.text.x=element_text(size=14, face='italic'),
          legend.text=element_text(size=12),
          legend.position = c(0.3, 0.83),
          legend.title = element_blank(),
         legend.box = "vertical")+facet_wrap(station~., ncol=1) 

biomass_conc


b_long_all_edit_site_conception %>% 
  group_by(ID_main) %>% 
  dplyr::summarise(max(mean),min(mean), mean(mean), sd(mean))

```

## Anchovy Sardine San Nicholas Island

```{r}
b_long_all_edit_site %>% 
  filter(., station ==  "2. San Nicholas Island") -> b_long_all_edit_site_sni


biomass_sni <- ggplot(data=b_long_all_edit_site_sni, aes(x=Year)) + 
    geom_rect_pattern(
    aes(
      xmin=2014, ymin=-3, xmax=2019, ymax=20,
      pattern_angle   = I(45),
      pattern_colour  = I("grey90"),
      pattern_spacing = I(0.05),
      pattern_size    = I(0.25)
    ),
    pattern         = 'stripe',
    fill            = 'white',
    colour          = 'white',
    pattern_density = 0.3
  ) +
  scale_color_manual(values=c("navy","darkred")) +
  geom_point(aes(y=`median_log`, group=Species, color=Species),size=2, na.rm = TRUE) +
  geom_line(aes(y=`median_log`,group=Species, color=Species),size=1, na.rm = TRUE) +
  geom_errorbar(aes(ymin = p05_log, ymax = p95_log,group=Species, color=Species), width = 0.1)  +
geom_line(data=sni_temp, aes(x=Year, y=(coeff2+two_month_sst*coeff1)), size = 2, color= "black") +
scale_y_continuous(
    
    # Features of the first axis
    name = "log(Abundance)",
    
    # Add a second axis and specify its features
    sec.axis = sec_axis(~(.-coeff2)/coeff1, name="SST ˚C")
  ) +
  theme_bw() +		## makes background white
  theme(  panel.background = element_rect(fill='white', colour='white'),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          axis.text.x=element_text(size=10, angle=20, hjust = 0.65), 
          axis.text.y=element_text(size=12, angle=0), 
          axis.title.x=element_text(size=16, angle=0,face="bold"), 
          axis.title.y=element_text(size=16, angle=90,face="bold"),
          strip.background = element_rect(fill='grey90'), 
          strip.text.x=element_text(size=14, face='italic'),
          legend.text=element_text(size=12),
          legend.position = c(0.3, 0.83),
          legend.title = element_blank(),
         legend.box = "vertical") +facet_wrap(station~., ncol=1) 

biomass_sni



b_long_all_edit_site_sni %>% 
  group_by(ID_main) %>% 
  dplyr::summarise(max(mean),min(mean), mean(mean), sd(mean))
```

## Anchovy Sardine San Diego Inshore

```{r}
b_long_all_edit_site %>% 
  filter(., station ==  "3. San Diego Inshore") -> b_long_all_edit_site_sdi


coeff1i <- 2.4
coeff2i <- -27


biomass_sdi <- ggplot(data=b_long_all_edit_site_sdi, aes(x=Year)) + 
    geom_rect_pattern(
    aes(
      xmin=2014, ymin=-3, xmax=2019, ymax=20,
      pattern_angle   = I(45),
      pattern_colour  = I("grey90"),
      pattern_spacing = I(0.05),
      pattern_size    = I(0.25)
    ),
    pattern         = 'stripe',
    fill            = 'white',
    colour          = 'white',
    pattern_density = 0.3
  ) +
  scale_color_manual(values=c("navy","darkred")) +
  geom_point(aes(y=`median_log`, group=Species, color=Species),size=2, na.rm = TRUE) +
  geom_line(aes(y=`median_log`,group=Species, color=Species),size=1, na.rm = TRUE) +
  geom_errorbar(aes(ymin = p05_log, ymax = p95_log,group=Species, color=Species), width = 0.1)  +
geom_line(data=sdi_temp, aes(x=Year, y=(coeff2i+two_month_sst*coeff1i)), size = 2, color= "black") +
scale_y_continuous(
    
    # Features of the first axis
    name = "log(Abundance)",
    
    # Add a second axis and specify its features
    sec.axis = sec_axis(~(.-coeff2)/coeff1, name="SST ˚C")
  ) +
  theme_bw() +		## makes background white
  theme(  panel.background = element_rect(fill='white', colour='white'),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          axis.text.x=element_text(size=10, angle=20, hjust = 0.65), 
          axis.text.y=element_text(size=12, angle=0), 
          axis.title.x=element_text(size=16, angle=0,face="bold"), 
          axis.title.y=element_text(size=16, angle=90,face="bold"),
          strip.background = element_rect(fill='grey90'), 
          strip.text.x=element_text(size=14, face='italic'),
          legend.text=element_text(size=12),
          legend.position = c(0.3, 0.83),
          legend.title = element_blank(),
         legend.box = "vertical") + facet_wrap(station~., ncol=1) 

biomass_sdi


b_long_all_edit_site_sdi %>% 
  group_by(ID_main) %>% 
  dplyr::summarise(max(mean),min(mean), mean(mean), sd(mean))

```

## Anchovy Sardine San Diego Offshore

```{r}
b_long_all_edit_site %>% 
  filter(., station ==  "4. San Diego Offshore") -> b_long_all_edit_site_sdo

biomass_sdo <- ggplot(data=b_long_all_edit_site_sdo, aes(x=Year)) + 
    geom_rect_pattern(
    aes(
      xmin=2014, ymin=-3, xmax=2019, ymax=20,
      pattern_angle   = I(45),
      pattern_colour  = I("grey90"),
      pattern_spacing = I(0.05),
      pattern_size    = I(0.25)
    ),
    pattern         = 'stripe',
    fill            = 'white',
    colour          = 'white',
    pattern_density = 0.3
  ) +
  scale_color_manual(values=c("navy","darkred")) +
  geom_point(aes(y=`median_log`, group=Species, color=Species),size=2, na.rm = TRUE) +
  geom_line(aes(y=`median_log`,group=Species, color=Species),size=1, na.rm = TRUE) +
  geom_errorbar(aes(ymin = p05_log, ymax = p95_log,group=Species, color=Species), width = 0.1)  +
geom_line(data=sdo_temp, aes(x=Year, y=(coeff2+two_month_sst*coeff1)), size = 2, color= "black") +
scale_y_continuous(
    
    # Features of the first axis
    name = "log(Abundance)",
    
    # Add a second axis and specify its features
    sec.axis = sec_axis(~(.-coeff2)/coeff1, name="SST ˚C")
  ) +
  theme_bw() +		## makes background white
  theme(  panel.background = element_rect(fill='white', colour='white'),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          axis.text.x=element_text(size=10, angle=20, hjust = 0.65), 
          axis.text.y=element_text(size=12, angle=0), 
          axis.title.x=element_text(size=16, angle=0,face="bold"), 
          axis.title.y=element_text(size=16, angle=90,face="bold"),
          strip.background = element_rect(fill='grey90'), 
          strip.text.x=element_text(size=14, face='italic'),
          legend.text=element_text(size=12),
          legend.position = c(0.3, 0.83),
          legend.title = element_blank(),
         legend.box = "vertical") + facet_wrap(station~., ncol=1) 

biomass_sdo



b_long_all_edit_site_sdo %>% 
  group_by(ID_main) %>% 
  dplyr::summarise(max(mean),min(mean), mean(mean), sd(mean))

b_long_all_edit_site_sdo %>% 
  filter(., Year >2004 & 2009 > Year) %>% 
  group_by(ID_main) %>% 
  dplyr::summarise(max(mean),min(mean), mean(mean), sd(mean))

b_long_all_edit_site_sni %>% 
  filter(., Year >2016) %>% 
  group_by(ID_main) %>% 
  dplyr::summarise(max(mean),min(mean), mean(mean), sd(mean))



b_long_all_edit_site %>% 
  mutate(., MHW = if_else(Year > 2013, "psotMHW","preMHW")) %>% 
  group_by(MHW, ID_main) %>% 
    dplyr::summarise(max(mean),min(mean), mean(mean), sd(mean))

b_long_all_edit_site %>% 
filter(., Year >2009 & 2014 > Year) %>% 
  group_by(ID_main) %>% 
    dplyr::summarise(max(mean),min(mean), mean(mean), sd(mean))

```
# Figure 5
```{r}


biomass_conc+biomass_sni+biomass_sdi+biomass_sdo +plot_layout(ncol=1)

ggsave(file =here::here("analysis","figures","Figure_5_anchovy_sardine_time_combined.png"), width = 8, height = 16)

```

